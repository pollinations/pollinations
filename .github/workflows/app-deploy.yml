name: Deploy Apps

on:
  push:
    paths:
      - 'apps/**'
    branches: [master, main, fix/chat-vite-base-path]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed apps
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          dir_names: true
          dir_names_max_depth: 2
          files: apps/**
          json: true

      # TODO: Remove debug logging once deployment system is stable in production
      - name: Debug changed files output
        run: |
          echo "ðŸ” Debug: Changed files output"
          echo "Raw output: $ALL_CHANGED"
          echo "Length: ${#ALL_CHANGED}"
          echo ""
          echo "ðŸ” Parsing with jq (from env var):"
          echo "$ALL_CHANGED" | jq '.' || echo "âŒ jq parsing failed"
          echo ""
          echo "ðŸ” Extracting app names:"
          echo "$ALL_CHANGED" | jq -r '.[]' | sed 's|^apps/||' | cut -d'/' -f1 | sort -u || echo "âŒ Extraction failed"
          echo ""
          echo "ðŸ” Alternative: Using fromjson"
          echo "$ALL_CHANGED" | jq -r 'fromjson | .[]' | sed 's|^apps/||' | cut -d'/' -f1 | sort -u || echo "âŒ fromjson failed"
        env:
          ALL_CHANGED: ${{ steps.changed.outputs.all_changed_files }}

      - name: Deploy
        if: steps.changed.outputs.all_changed_files != '[]'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TURNSTILE_SITE_ID: ${{ secrets.TURNSTILE_SITE_ID }}
          CHANGED_FILES_JSON: ${{ steps.changed.outputs.all_changed_files }}
        run: |
          npm install -g wrangler
          
          echo "ðŸš€ Starting deployment process..."
          # TODO: Remove debug logging once deployment system is stable
          echo "Raw changed files: $CHANGED_FILES_JSON"
          
          # The output has escaped quotes (\"), remove the backslashes
          echo "$CHANGED_FILES_JSON" | sed 's/\\"/"/g' | jq -r '.[]' | \
            sed 's|^apps/||' | cut -d'/' -f1 | sort -u | while read app; do
            
            echo "ðŸ” Processing app: '$app'"
            
            if [ -z "$app" ]; then
              echo "  â­ï¸  Skipping: empty app name"
              continue
            fi
            
            if [ "$app" = "scripts" ]; then
              echo "  â­ï¸  Skipping: scripts directory"
              continue
            fi
            
            if [ "$app" = "apps.json" ]; then
              echo "  â­ï¸  Skipping: apps.json config file"
              continue
            fi
            
            if [ ! -d "apps/$app" ]; then
              echo "  â­ï¸  Skipping: directory doesn't exist"
              continue
            fi
            
            echo "ðŸš€ Deploying $app..."
            
            # Step 1: Setup infrastructure (project, domain, DNS)
            cd apps
            node scripts/deploy-app.js "$app" || echo "âš ï¸  Infrastructure setup completed with warnings"
            cd ..
            
            # Step 2: Build if needed
            if [ -f "apps/$app/package.json" ]; then
              cd "apps/$app"
              npm install && npm run build 2>/dev/null || true
              cd ../..
              DIR=$([ -d "apps/$app/dist" ] && echo "dist" || echo ".")
            else
              DIR="."
            fi
            
            # Step 3: Deploy to production
            wrangler pages deploy "apps/$app/$DIR" \
              --project-name="pollinations-$app" \
              --branch=main \
              --commit-dirty=true
            
            echo "âœ… Deployment complete for $app"
          done
