name: Automate Project Submission

on:
  issues:
    types: [opened, labeled]

jobs:
  process_submission:
    if: contains(github.event.issue.labels.*.name, 'APPS')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Parse Issue Form Data
        id: parse
        run: |
          # Extract issue body
          ISSUE_BODY=$(jq -r '.issue.body' $GITHUB_EVENT_PATH)
          
          # Parse form fields using grep and sed
          PROJECT_NAME=$(echo "$ISSUE_BODY" | grep -A 2 "### Project Name" | tail -n 1 | sed 's/^[[:space:]]*//' | sed 's/^[*-][[:space:]]*//' | sed 's/^.*: //' | xargs)
          PROJECT_URL=$(echo "$ISSUE_BODY" | grep -A 2 "### Project URL" | tail -n 1 | sed 's/^[[:space:]]*//' | sed 's/^[*-][[:space:]]*//' | sed 's/^.*: //' | xargs)
          PROJECT_DESCRIPTION=$(echo "$ISSUE_BODY" | grep -A 2 "### Project Description" | tail -n 1 | sed 's/^[[:space:]]*//' | sed 's/^[*-][[:space:]]*//' | sed 's/^.*: //' | xargs)
          CONTACT_INFO=$(echo "$ISSUE_BODY" | grep -A 2 "### Contact Information" | tail -n 1 | sed 's/^[[:space:]]*//' | sed 's/^[*-][[:space:]]*//' | sed 's/^.*: //' | xargs)
          GITHUB_REPO=$(echo "$ISSUE_BODY" | grep -A 2 "### GitHub Repository URL" | tail -n 1 | sed 's/^[[:space:]]*//' | sed 's/^[*-][[:space:]]*//' | sed 's/^.*: //' | xargs || echo "")
          PROJECT_CATEGORY=$(echo "$ISSUE_BODY" | grep -A 2 "### Project Category" | tail -n 1 | sed 's/^[[:space:]]*//' | sed 's/^[*-][[:space:]]*//' | xargs)
          
          # Export variables for use in later steps
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "PROJECT_URL=$PROJECT_URL" >> $GITHUB_ENV
          echo "PROJECT_DESCRIPTION=$PROJECT_DESCRIPTION" >> $GITHUB_ENV
          echo "CONTACT_INFO=$CONTACT_INFO" >> $GITHUB_ENV
          echo "GITHUB_REPO=$GITHUB_REPO" >> $GITHUB_ENV
          echo "PROJECT_CATEGORY=$PROJECT_CATEGORY" >> $GITHUB_ENV

      - name: Categorize Project
        id: categorize
        run: |
          # Map category to file name
          case ${{ env.PROJECT_CATEGORY }} in
            "Chat Projects ðŸ’¬")
              CATEGORY_FILE="chat.js"
              ;;
            "Creative Projects ðŸŽ¨")
              CATEGORY_FILE="creative.js"
              ;;
            "Games ðŸŽ®")
              CATEGORY_FILE="games.js"
              ;;
            "Hack & Build ðŸ› ï¸")
              CATEGORY_FILE="hackAndBuild.js"
              ;;
            "Learn ðŸ“š")
              CATEGORY_FILE="learn.js"
              ;;
            "Social Bots ðŸ¤–")
              CATEGORY_FILE="socialBots.js"
              ;;
            "Vibe Coding ðŸŒˆ")
              CATEGORY_FILE="vibeCoding.js"
              ;;
            *)
              echo "Unknown category: ${{ env.PROJECT_CATEGORY }}"
              exit 1
              ;;
          esac
          
          echo "CATEGORY_FILE=$CATEGORY_FILE" >> $GITHUB_ENV

      - name: Add Project to Category File
        id: add_project
        run: |
          # Get current date in YYYY-MM-DD format
          SUBMISSION_DATE=$(date +%Y-%m-%d)
          
          # Create the project entry
          PROJECT_ENTRY="  {
    name: \"${{ env.PROJECT_NAME }}\",
    url: \"${{ env.PROJECT_URL }}\",
    description: \"${{ env.PROJECT_DESCRIPTION }}\",
    author: \"${{ env.CONTACT_INFO }}\",
    submissionDate: \"$SUBMISSION_DATE\",
    order: 1
  }"
          
          # If GitHub repo is provided, add it to the entry
          if [ -n "${{ env.GITHUB_REPO }}" ] && [ "${{ env.GITHUB_REPO }}" != "No response" ]; then
            PROJECT_ENTRY="  {
    name: \"${{ env.PROJECT_NAME }}\",
    url: \"${{ env.PROJECT_URL }}\",
    description: \"${{ env.PROJECT_DESCRIPTION }}\",
    author: \"${{ env.CONTACT_INFO }}\",
    repo: \"${{ env.GITHUB_REPO }}\",
    submissionDate: \"$SUBMISSION_DATE\",
    order: 1
  }"
          fi
          
          # Add the project entry to the beginning of the array in the category file
          CATEGORY_FILE_PATH="pollinations.ai/src/config/projects/${{ env.CATEGORY_FILE }}"
          
          # Use node.js script to add the project entry properly
          # Create a temporary script file
          cat > add_project.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // Get environment variables
          const projectName = process.env.PROJECT_NAME;
          const projectUrl = process.env.PROJECT_URL;
          const projectDescription = process.env.PROJECT_DESCRIPTION;
          const contactInfo = process.env.CONTACT_INFO;
          const githubRepo = process.env.GITHUB_REPO;
          const submissionDate = process.env.SUBMISSION_DATE;
          const categoryFile = process.env.CATEGORY_FILE;
          
          // Create the project entry
          let projectEntry = {
            name: projectName,
            url: projectUrl,
            description: projectDescription,
            author: contactInfo,
            submissionDate: submissionDate,
            order: 1
          };
          
          // Add repo if provided
          if (githubRepo && githubRepo !== "No response") {
            projectEntry.repo = githubRepo;
          }
          
          // Read the category file
          const categoryFilePath = path.join('pollinations.ai', 'src', 'config', 'projects', categoryFile);
          let fileContent = fs.readFileSync(categoryFilePath, 'utf8');
          
          // Convert the project entry to a string
          const projectEntryString = JSON.stringify(projectEntry, null, 2)
            .replace(/^{\n/, '{\n  ')
            .replace(/\n}/, '\n  }')
            .replace(/"/g, '"')
            .replace(/\\n/g, '\n');
          
          // Insert the project entry after the opening bracket of the array
          fileContent = fileContent.replace(
            /(export const \w+ = \[\n)/,
            `$1  ${projectEntryString},\n`
          );
          
          // Write the updated content back to the file
          fs.writeFileSync(categoryFilePath, fileContent);
          EOF
          
          # Set environment variables for the node script
          export PROJECT_NAME="${{ env.PROJECT_NAME }}"
          export PROJECT_URL="${{ env.PROJECT_URL }}"
          export PROJECT_DESCRIPTION="${{ env.PROJECT_DESCRIPTION }}"
          export CONTACT_INFO="${{ env.CONTACT_INFO }}"
          export GITHUB_REPO="${{ env.GITHUB_REPO }}"
          export SUBMISSION_DATE="$SUBMISSION_DATE"
          export CATEGORY_FILE="${{ env.CATEGORY_FILE }}"
          
          # Run the node script
          node add_project.js

      - name: Run Project List Generation Script
        run: |
          node pollinator-agent/project-list-scripts/generate-project-table.js --update-readme

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Add ${{ env.PROJECT_NAME }} to ${{ env.PROJECT_CATEGORY }}
            
            Co-authored-by: ${{ github.event.issue.user.login }} <${{ github.event.issue.user.id }}+${{ github.event.issue.user.login }}@users.noreply.github.com>
            Closes #${{ github.event.issue.number }}
          title: "Add ${{ env.PROJECT_NAME }} to ${{ env.PROJECT_CATEGORY }}"
          body: |
            Adds `${{ env.PROJECT_NAME }}` to the `${{ env.PROJECT_CATEGORY }}` category.
            
            Closes #${{ github.event.issue.number }}
          branch: add-project-${{ github.event.issue.number }}
          delete-branch: true