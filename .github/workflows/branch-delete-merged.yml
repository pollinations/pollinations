name: PR Delete Branch

on:
  pull_request:
    types: [closed]

jobs:
  delete-branch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Generate Pollinations AI Token
        id: pollinations-ai
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}
          owner: pollinations

      - name: Delete merged branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.pollinations-ai.outputs.token }}
          script: |
            const PROTECTED = ['main', 'master', 'production'];
            const branch = context.payload.pull_request.head.ref;
            const repo = context.payload.pull_request.head.repo;

            // Skip if branch is from a fork
            if (repo.fork) {
              console.log(`Skipping: branch "${branch}" is from a fork`);
              return;
            }

            // Skip protected branches
            if (PROTECTED.includes(branch)) {
              console.log(`Skipping: "${branch}" is protected`);
              return;
            }

            console.log(`Deleting branch: ${branch}`);

            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`
              });
              console.log(`Deleted branch: ${branch}`);
            } catch (err) {
              console.log(`Failed to delete ${branch}: ${err.message}`);
            }
