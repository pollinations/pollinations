name: Cleanup Old Branches

on:
  workflow_dispatch:
    inputs:
      days_old:
        description: 'Delete branches older than X days'
        required: true
        type: number

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Pollinations AI Token
        id: pollinations-ai
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}
          owner: pollinations

      - name: Delete old branches
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.pollinations-ai.outputs.token }}
          script: |
            const DAYS = ${{ github.event.inputs.days_old }};
            const PROTECTED = ['main', 'master', 'production'];
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - DAYS);

            console.log(`Deleting branches older than ${DAYS} days (before ${cutoffDate.toISOString().split('T')[0]})`);
            console.log(`Protected branches: ${PROTECTED.join(', ')}`);
            console.log('----------------------------------------');

            // GraphQL query to get all branches with their last commit date
            const query = `
              query($owner: String!, $repo: String!, $cursor: String) {
                repository(owner: $owner, name: $repo) {
                  refs(refPrefix: "refs/heads/", first: 100, after: $cursor) {
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                    nodes {
                      name
                      target {
                        ... on Commit {
                          committedDate
                        }
                      }
                    }
                  }
                }
              }
            `;

            const [owner, repo] = '${{ github.repository }}'.split('/');
            let deleted = 0;
            let skipped = 0;
            let cursor = null;

            // Paginate through all branches
            do {
              const result = await github.graphql(query, { owner, repo, cursor });
              const refs = result.repository.refs;

              for (const branch of refs.nodes) {
                // Skip protected branches
                if (PROTECTED.includes(branch.name)) {
                  console.log(`PROTECTED: ${branch.name}`);
                  continue;
                }

                const lastCommit = new Date(branch.target.committedDate);

                if (lastCommit < cutoffDate) {
                  console.log(`DELETING: ${branch.name} (last commit: ${lastCommit.toISOString().split('T')[0]})`);
                  try {
                    await github.rest.git.deleteRef({
                      owner,
                      repo,
                      ref: `heads/${branch.name}`
                    });
                    deleted++;
                  } catch (err) {
                    console.log(`  Failed to delete ${branch.name}: ${err.message}`);
                  }
                } else {
                  skipped++;
                }
              }

              cursor = refs.pageInfo.hasNextPage ? refs.pageInfo.endCursor : null;
            } while (cursor);

            console.log('----------------------------------------');
            console.log(`Summary: Deleted ${deleted} branches, kept ${skipped} branches (+ protected)`);

            return { deleted, skipped };
