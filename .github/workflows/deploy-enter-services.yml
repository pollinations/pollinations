name: Deploy to enter-services

on:
  push:
    branches:
      - staging
      - feature/encrypt-gptimage-env
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Enable test mode (skips actual deployment)'
        required: false
        type: boolean
        default: false
      issue_number:
        description: 'Issue number to test with (optional, for manual testing)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Display workflow inputs
        run: |
          echo "üîß Workflow triggered with:"
          echo "  Test Mode: ${{ github.event.inputs.test_mode || 'false' }}"
          echo "  Issue Number: ${{ github.event.inputs.issue_number || 'none' }}"
          echo "  Branch: ${{ github.ref_name }}"
          
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SOPS
        uses: nhedger/setup-sops@v2

      - name: Decrypt .env files with SOPS
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          # Decrypt .encrypted.env files to .env
          if [ -f "text.pollinations.ai/.encrypted.env" ]; then
            sops -d text.pollinations.ai/.encrypted.env > text.pollinations.ai/.env
            echo "‚úÖ Decrypted text.pollinations.ai/.env"
          fi
          
          if [ -f "image.pollinations.ai/.encrypted.env" ]; then
            sops -d image.pollinations.ai/.encrypted.env > image.pollinations.ai/.env
            echo "‚úÖ Decrypted image.pollinations.ai/.env"
          fi
          
          if [ -f "enter.pollinations.ai/.encrypted.staging.env" ]; then
            sops -d enter.pollinations.ai/.encrypted.staging.env > enter.pollinations.ai/.dev.vars
            echo "‚úÖ Decrypted enter.pollinations.ai/.dev.vars"
          fi

      - name: Copy decrypted .env files to server
        if: ${{ github.event.inputs.test_mode != 'true' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ENTER_SERVICES_HOST }}
          username: ${{ secrets.ENTER_SERVICES_USER }}
          key: ${{ secrets.ENTER_SERVICES_SSH_KEY }}
          fingerprint: ${{ secrets.ENTER_SERVICES_FINGERPRINT }}
          source: "text.pollinations.ai/.env,image.pollinations.ai/.env"
          target: "/home/ubuntu/pollinations/"
          strip_components: 0

      - name: Deploy via SSH
        if: ${{ github.event.inputs.test_mode != 'true' }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ENTER_SERVICES_HOST }}
          username: ${{ secrets.ENTER_SERVICES_USER }}
          key: ${{ secrets.ENTER_SERVICES_SSH_KEY }}
          fingerprint: ${{ secrets.ENTER_SERVICES_FINGERPRINT }}
          script: |
            set -e
            
            echo "üöÄ Starting deployment to enter-services..."
            
            # Navigate to repo
            cd /home/ubuntu/pollinations
            
            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git pull origin staging
            
            # Update text service
            echo "üìù Updating text.pollinations.ai..."
            cd text.pollinations.ai
            pnpm install --frozen-lockfile || pnpm install
            echo "‚úÖ Text service dependencies installed"
            
            # Update image service
            echo "üñºÔ∏è  Updating image.pollinations.ai..."
            cd ../image.pollinations.ai
            pnpm install --frozen-lockfile || pnpm install
            echo "‚úÖ Image service dependencies installed"
            
            # Restart systemd services
            echo "üîÑ Restarting systemd services..."
            sudo systemctl restart text-pollinations.service image-pollinations.service
            
            # Wait for services to be ready
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            # Verify services are running
            echo "‚úÖ Verifying service status..."
            sudo systemctl is-active text-pollinations.service || exit 1
            sudo systemctl is-active image-pollinations.service || exit 1
            
            # Health check endpoints
            echo "üè• Running health checks..."
            sleep 2  # Give services a moment to fully initialize
            
            # Check text service health
            TEXT_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:16385/models || echo "000")
            if [ "$TEXT_HEALTH" != "200" ]; then
              echo "‚ùå Text service health check failed (HTTP $TEXT_HEALTH)"
              exit 1
            fi
            echo "‚úÖ Text service responding (HTTP 200)"
            
            # Check image service health
            IMAGE_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:16384/models || echo "000")
            if [ "$IMAGE_HEALTH" != "200" ]; then
              echo "‚ùå Image service health check failed (HTTP $IMAGE_HEALTH)"
              exit 1
            fi
            echo "‚úÖ Image service responding (HTTP 200)"
            
            echo "üéâ Deployment complete!"
            echo "üìä Service Status:"
            sudo systemctl status text-pollinations.service image-pollinations.service --no-pager | grep -E "Active:|running"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Deploy enter.pollinations.ai to Cloudflare
        if: ${{ github.event.inputs.test_mode != 'true' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          set -e
          
          echo "‚òÅÔ∏è Deploying enter.pollinations.ai to Cloudflare Workers..."
          
          cd enter.pollinations.ai
          
          # Install dependencies
          echo "üì¶ Installing dependencies..."
          npm install
          
          # Deploy to staging
          echo "üöÄ Deploying to staging environment..."
          npm run deploy:staging
          
          echo "‚úÖ enter.pollinations.ai deployed to Cloudflare Workers!"
      
      - name: Test mode summary
        if: ${{ github.event.inputs.test_mode == 'true' }}
        run: |
          echo "üß™ Test mode enabled - deployment steps were skipped"
          echo "‚úÖ Workflow validation successful!"
          if [ -n "${{ github.event.inputs.issue_number }}" ]; then
            echo "üìã Testing with issue #${{ github.event.inputs.issue_number }}"
          fi
