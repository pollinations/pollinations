name: Deploy to enter-services

on:
  push:
    branches:
      - production
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SOPS
        uses: nhedger/setup-sops@v2

      - name: Decrypt .env files with SOPS
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          if [ -f "text.pollinations.ai/secrets/env.json" ]; then
            sops --output-type dotenv -d text.pollinations.ai/secrets/env.json > text.pollinations.ai/.env
            echo "‚úÖ Decrypted text.pollinations.ai/.env"
          fi
          
          if [ -f "image.pollinations.ai/secrets/env.json" ]; then
            sops --output-type dotenv -d image.pollinations.ai/secrets/env.json > image.pollinations.ai/.env
            echo "‚úÖ Decrypted image.pollinations.ai/.env"
          fi

      - name: Copy .env files to staging server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ENTER_SERVICES_STAGING_HOST }}
          username: ${{ secrets.ENTER_SERVICES_STAGING_USER }}
          key: ${{ secrets.ENTER_SERVICES_STAGING_SSH_KEY }}
          source: "text.pollinations.ai/.env,image.pollinations.ai/.env"
          target: "/home/ubuntu/pollinations/"
          strip_components: 0

      - name: Deploy to staging via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          PLN_ENTER_TOKEN: ${{ secrets.PLN_ENTER_TOKEN }}
        with:
          host: ${{ secrets.ENTER_SERVICES_STAGING_HOST }}
          username: ${{ secrets.ENTER_SERVICES_STAGING_USER }}
          key: ${{ secrets.ENTER_SERVICES_STAGING_SSH_KEY }}
          envs: PLN_ENTER_TOKEN
          script: |
            set -e
            echo "üöÄ Deploying to STAGING..."
            cd /home/ubuntu/pollinations
            git pull origin staging
            
            cd text.pollinations.ai
            pnpm install --frozen-lockfile || pnpm install
            
            cd ../image.pollinations.ai
            pnpm install --frozen-lockfile || pnpm install
            
            sudo systemctl restart text-pollinations.service image-pollinations.service
            sleep 10
            
            sudo systemctl is-active text-pollinations.service || exit 1
            sudo systemctl is-active image-pollinations.service || exit 1
            
            echo "üéâ Staging deployment complete!"

  deploy-production:
    if: github.ref == 'refs/heads/production' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SOPS
        uses: nhedger/setup-sops@v2

      - name: Decrypt .env files with SOPS
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          # Decrypt .encrypted.env files to .env
          if [ -f "text.pollinations.ai/secrets/env.json" ]; then
            sops --output-type dotenv -d text.pollinations.ai/secrets/env.json > text.pollinations.ai/.env
            echo "‚úÖ Decrypted text.pollinations.ai/.env"
          fi
          
          if [ -f "image.pollinations.ai/secrets/env.json" ]; then
            sops --output-type dotenv -d image.pollinations.ai/secrets/env.json > image.pollinations.ai/.env
            echo "‚úÖ Decrypted image.pollinations.ai/.env"
          fi

      - name: Copy decrypted .env files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ENTER_SERVICES_HOST }}
          username: ${{ secrets.ENTER_SERVICES_USER }}
          key: ${{ secrets.ENTER_SERVICES_SSH_KEY }}
          source: "text.pollinations.ai/.env,image.pollinations.ai/.env"
          target: "/home/ubuntu/pollinations/"
          strip_components: 0

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          PLN_ENTER_TOKEN: ${{ secrets.PLN_ENTER_TOKEN }}
        with:
          host: ${{ secrets.ENTER_SERVICES_HOST }}
          username: ${{ secrets.ENTER_SERVICES_USER }}
          key: ${{ secrets.ENTER_SERVICES_SSH_KEY }}
          envs: PLN_ENTER_TOKEN
          script: |
            set -e
            
            echo "üöÄ Starting deployment to enter-services..."
            
            # Navigate to repo
            cd /home/ubuntu/pollinations
            
            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git pull origin production
            
            # Update text service
            echo "üìù Updating text.pollinations.ai..."
            cd text.pollinations.ai
            pnpm install --frozen-lockfile || pnpm install
            echo "‚úÖ Text service dependencies installed"
            
            # Update image service
            echo "üñºÔ∏è  Updating image.pollinations.ai..."
            cd ../image.pollinations.ai
            pnpm install --frozen-lockfile || pnpm install
            echo "‚úÖ Image service dependencies installed"
            
            # Restart systemd services
            echo "üîÑ Restarting systemd services..."
            sudo systemctl restart text-pollinations.service image-pollinations.service
            
            # Wait for services to be ready
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            # Verify services are running
            echo "‚úÖ Verifying service status..."
            sudo systemctl is-active text-pollinations.service || exit 1
            sudo systemctl is-active image-pollinations.service || exit 1
            
            # Health check endpoints
            echo "üè• Running health checks..."
            sleep 2  # Give services a moment to fully initialize
            
            # PLN_ENTER_TOKEN is passed as environment variable from GitHub secret
            echo "Using PLN_ENTER_TOKEN: ${PLN_ENTER_TOKEN:0:10}..."
            
            # Check text service health (use /openai/models - /models returns 410 deprecated)
            TEXT_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" -H "x-enter-token: $PLN_ENTER_TOKEN" http://localhost:16385/openai/models || echo "000")
            if [ "$TEXT_HEALTH" != "200" ]; then
              echo "‚ùå Text service health check failed (HTTP $TEXT_HEALTH)"
              exit 1
            fi
            echo "‚úÖ Text service responding (HTTP 200)"
            
            # Check image service health (use /about - /models returns 410 deprecated)
            IMAGE_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" -H "x-enter-token: $PLN_ENTER_TOKEN" http://localhost:16384/about || echo "000")
            if [ "$IMAGE_HEALTH" != "200" ]; then
              echo "‚ùå Image service health check failed (HTTP $IMAGE_HEALTH)"
              exit 1
            fi
            echo "‚úÖ Image service responding (HTTP 200)"
            
            echo "üéâ Deployment complete!"
            echo "üìä Service Status:"
            sudo systemctl status text-pollinations.service image-pollinations.service --no-pager | grep -E "Active:|running"
