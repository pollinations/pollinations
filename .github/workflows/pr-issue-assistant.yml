# Polly Bot - AI assistant via Pollinations AI
# Trigger: polly | Whitelist: voodoohop, ElliotEtag, eulervoid, Circuit-Overtime, Itachi-1824

name: Polly

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  unauthorized:
    if: |
      !contains(fromJSON('["voodoohop", "ElliotEtag", "eulervoid", "Circuit-Overtime", "Itachi-1824"]'), github.actor) &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'polly')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, 'polly')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, 'polly')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, 'polly') || contains(github.event.issue.title, 'polly')))
      )
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue?.number || context.payload.pull_request?.number,
              body: `Sorry @${context.actor}, only whitelisted users can use Polly.`
            });

  polly:
    if: |
      contains(fromJSON('["voodoohop", "ElliotEtag", "eulervoid", "Circuit-Overtime", "Itachi-1824"]'), github.actor) &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'polly')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, 'polly')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, 'polly')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, 'polly') || contains(github.event.issue.title, 'polly')))
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    env:
      POLLINATIONS_TOKEN: ${{ secrets.POLLINATIONS_TOKEN }}
    steps:
      - name: Setup Router Config
        run: |
          mkdir -p $HOME/.claude-code-router
          cat << 'EOF' > $HOME/.claude-code-router/config.json
          {"LOG":false,"NON_INTERACTIVE_MODE":true,"API_TIMEOUT_MS":600000,"Providers":[{"name":"pollinations","api_base_url":"https://gen.pollinations.ai/v1/chat/completions","api_key":"${POLLINATIONS_TOKEN}","models":["claude-large","claude-small","kimi-k2-thinking","perplexity-reasoning","gpt-4o","gpt-4o-mini"]}],"Router":{"default":"pollinations,claude-large","background":"pollinations,claude-small","think":"pollinations,kimi-k2-thinking","longContext":"pollinations,claude-large","longContextThreshold":60000,"webSearch":"pollinations,perplexity-reasoning"}}
          EOF

      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}
          repository: ${{ github.repository }}
          token: ${{ steps.token.outputs.token }}

      - uses: oven-sh/setup-bun@v2

      - name: Start Router
        run: |
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: "ccr-pollinations"
          github_token: ${{ steps.token.outputs.token }}
          trigger_phrase: "polly"
          additional_permissions: |
            actions: read
