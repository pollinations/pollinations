# Pollinations AI - Multi-Model Review Assistant (SuperPolly)
# Trigger: superpolly | Whitelist: voodoohop, ElliotEtag, eulervoid, Circuit-Overtime, Itachi-1824
#
# Architecture: 4 specialized models review in parallel, then 1 aggregator synthesizes
# - Claude Opus 4.5 (claude-large): Security specialist - best-in-class security robustness (4.7% injection success rate)
# - GPT 5.2 (openai-large): Bug hunter - best async code review, catches cross-system bugs
# - Gemini 3 Pro (gemini-large): Architecture reviewer - native multimodal, design patterns
# - Kimi K2 Thinking (kimi-k2-thinking): Performance & reasoning - transparent chain-of-thought, systematic debugging

name: SuperPolly

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  check-trigger:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'superpolly')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, 'superpolly')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, 'superpolly')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, 'superpolly') || contains(github.event.issue.title, 'superpolly')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    outputs:
      authorized: ${{ steps.whitelist.outputs.authorized }}
      app-slug: ${{ steps.token.outputs.app-slug }}
      user-id: ${{ steps.setup.outputs.user-id }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - name: Check Whitelist
        id: whitelist
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.token.outputs.token }}
          script: |
            let body = '';
            if (context.eventName === 'issue_comment' || context.eventName === 'pull_request_review_comment') {
              body = context.payload.comment?.body || '';
            } else if (context.eventName === 'issues') {
              body = (context.payload.issue?.body || '') + (context.payload.issue?.title || '');
            } else if (context.eventName === 'pull_request_review') {
              body = context.payload.review?.body || '';
            }

            if (!body.includes('superpolly')) {
              console.log('Strict check failed: "superpolly" must be lowercase.');
              core.setOutput('authorized', 'false');
              return;
            }

            const whitelist = ['voodoohop', 'ElliotEtag', 'eulervoid', 'Circuit-Overtime', 'Itachi-1824'];
            const actor = context.actor;
            if (!whitelist.includes(actor)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue?.number || context.payload.pull_request?.number,
                body: `Sorry @${actor}, only whitelisted users can use SuperPolly.`
              });
              core.setOutput('authorized', 'false');
            } else {
              core.setOutput('authorized', 'true');
            }

      - name: Add Reaction
        if: steps.whitelist.outputs.authorized == 'true'
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions -f content=rocket || true
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            gh api repos/${{ github.repository }}/pulls/comments/${{ github.event.comment.id }}/reactions -f content=rocket || true
          elif [ "${{ github.event_name }}" = "issues" ]; then
            gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions -f content=rocket || true
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/reactions -f content=rocket || true
          fi
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}

      - name: Get Bot User ID
        if: steps.whitelist.outputs.authorized == 'true'
        id: setup
        run: |
          BOT_USER_ID=$(gh api "/users/${{ steps.token.outputs.app-slug }}[bot]" --jq .id)
          echo "user-id=$BOT_USER_ID" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}

  # ============================================================================
  # PARALLEL REVIEW JOBS - All 4 run concurrently with specialized roles
  # ============================================================================

  # Claude Opus 4.5 - SECURITY SPECIALIST
  # Why: Best-in-class security (4.7% prompt injection success rate), excellent at detecting manipulation
  review-claude:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["claude-large", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,claude-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}

      - name: Run Claude Review
        run: |
          npm install -g @anthropic-ai/claude-code

          cat > /tmp/prompt.txt << 'PROMPT'
          You are Claude Opus 4.5, the SECURITY SPECIALIST in a multi-model code review team.
          Your primary focus: Security vulnerabilities, but report any issues you find.
          Security priorities: Input validation (SQL/XSS/command injection), auth flaws, data exposure, secrets handling, cryptographic issues, race conditions, prompt injection in AI code.

          Review the code in this repository. Be concise. Include file paths and line numbers.
          PROMPT

          echo "## Claude (Security)" > review.md
          echo "" >> review.md
          claude -p "$(cat /tmp/prompt.txt)" --dangerously-skip-permissions --output-format text >> review.md 2>&1 || echo "Review completed with warnings" >> review.md
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
          ANTHROPIC_API_KEY: "ccr-pollinations"

      - name: Upload Review
        uses: actions/upload-artifact@v4
        with:
          name: review-claude
          path: review.md

  # GPT 5.2 - BUG HUNTER
  # Why: Best-in-class async code review, 98.7% tool-calling accuracy, catches cross-system bugs
  review-openai:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              body.reasoning_effort = 'xhigh';
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["openai-large", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,openai-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}

      - name: Run OpenAI Review
        run: |
          npm install -g @anthropic-ai/claude-code

          cat > /tmp/prompt.txt << 'PROMPT'
          You are GPT 5.2, the BUG HUNTER in a multi-model code review team.
          Your primary focus: Finding bugs and logic errors, but report any issues you find.
          Bug hunting priorities: Logic errors, edge cases, null/undefined handling, error handling, off-by-one errors, cross-file dependencies, async race conditions.

          Review the code in this repository. Be concise. Include file paths and line numbers.
          PROMPT

          echo "## GPT 5.2 (Bugs)" > review.md
          echo "" >> review.md
          claude -p "$(cat /tmp/prompt.txt)" --dangerously-skip-permissions --output-format text >> review.md 2>&1 || echo "Review completed with warnings" >> review.md
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
          ANTHROPIC_API_KEY: "ccr-pollinations"

      - name: Upload Review
        uses: actions/upload-artifact@v4
        with:
          name: review-openai
          path: review.md

  # Gemini 3 Pro - ARCHITECTURE REVIEWER
  # Why: Native multimodal, excellent at design patterns, relates diagrams to code
  review-gemini:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          # Gemini Schema Fix - handles thought_signature and cleans unsupported schema props
          cat > $HOME/.claude-code-router/plugins/gemini-schema-fix.js << 'SCHEMAFIX'
          const UNSUPPORTED = ['propertyNames', 'patternProperties', 'additionalItems', 'unevaluatedProperties', 'unevaluatedItems', 'contentEncoding', 'contentMediaType', 'contentSchema', '$schema', '$id', '$ref', '$defs', 'definitions', 'if', 'then', 'else', 'allOf', 'anyOf', 'oneOf', 'not', 'dependentSchemas', 'dependentRequired', 'minContains', 'maxContains'];

          function cleanSchema(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            if (Array.isArray(obj)) return obj.map(cleanSchema);
            const cleaned = {};
            for (const [key, value] of Object.entries(obj)) {
              if (!UNSUPPORTED.includes(key)) {
                cleaned[key] = cleanSchema(value);
              }
            }
            return cleaned;
          }

          class GeminiSchemaFixTransformer {
            constructor(options) {
              this.name = 'gemini-schema-fix';
              this.SKIP_SIGNATURE = 'skip_thought_signature_validator';
            }
            async transformRequestIn(body, provider, context) {
              const model = (body.model || '').toLowerCase();
              const isGemini = model.includes('gemini');

              // Add thought_signature bypass for Gemini
              if (isGemini && body.messages) {
                body.messages = body.messages.map(msg => {
                  if (msg.role === 'assistant' && msg.tool_calls && Array.isArray(msg.tool_calls)) {
                    return {
                      ...msg,
                      tool_calls: msg.tool_calls.map(tc => {
                        if (tc.function && !tc.function.thought_signature) {
                          return { ...tc, function: { ...tc.function, thought_signature: this.SKIP_SIGNATURE } };
                        }
                        return tc;
                      })
                    };
                  }
                  return msg;
                });
              }

              // Clean tool schemas for all models (removes unsupported JSON schema props)
              if (body.tools && Array.isArray(body.tools)) {
                body.tools = body.tools.map(tool => {
                  if (tool.function && tool.function.parameters) {
                    tool.function.parameters = cleanSchema(tool.function.parameters);
                  }
                  return tool;
                });
              }
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = GeminiSchemaFixTransformer;
          SCHEMAFIX

          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              body.reasoning_effort = 'high';
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/gemini-schema-fix.js", "options": {}},
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["gemini-large", "perplexity-reasoning"],
              "transformer": {"use": ["gemini-schema-fix", "superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,gemini-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}

      - name: Run Gemini Review
        run: |
          npm install -g @anthropic-ai/claude-code

          cat > /tmp/prompt.txt << 'PROMPT'
          You are Gemini 3 Pro, the ARCHITECTURE REVIEWER in a multi-model code review team.
          Your primary focus: Code structure and design, but report any issues you find.
          Architecture priorities: Code organization, modularity, design patterns, dependency coupling, API design, maintainability, technical debt, DRY violations.

          Review the code in this repository. Be concise. Include file paths and line numbers.
          PROMPT

          echo "## Gemini 3 Pro (Architecture)" > review.md
          echo "" >> review.md
          claude -p "$(cat /tmp/prompt.txt)" --dangerously-skip-permissions --output-format text >> review.md 2>&1 || echo "Review completed with warnings" >> review.md
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
          ANTHROPIC_API_KEY: "ccr-pollinations"

      - name: Upload Review
        uses: actions/upload-artifact@v4
        with:
          name: review-gemini
          path: review.md

  # Kimi K2 Thinking - PERFORMANCE & REASONING ANALYST
  # Why: Transparent chain-of-thought, systematic debugging, excellent audit trails
  review-kimi:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["kimi-k2-thinking", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,kimi-k2-thinking",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}

      - name: Run Kimi Review
        run: |
          npm install -g @anthropic-ai/claude-code

          cat > /tmp/prompt.txt << 'PROMPT'
          You are Kimi K2 Thinking, the PERFORMANCE & REASONING ANALYST in a multi-model code review team.
          Your primary focus: Performance issues and deep reasoning, but report any issues you find.
          Performance priorities: Algorithmic complexity O(n), memory leaks, N+1 queries, unnecessary computations, caching opportunities, resource cleanup, async inefficiencies.

          Review the code in this repository. Be concise. Include file paths and line numbers.
          PROMPT

          echo "## Kimi K2 (Performance)" > review.md
          echo "" >> review.md
          claude -p "$(cat /tmp/prompt.txt)" --dangerously-skip-permissions --output-format text >> review.md 2>&1 || echo "Review completed with warnings" >> review.md
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
          ANTHROPIC_API_KEY: "ccr-pollinations"

      - name: Upload Review
        uses: actions/upload-artifact@v4
        with:
          name: review-kimi
          path: review.md

  # ============================================================================
  # AGGREGATION JOB - Synthesizes all 4 reviews into final verdict
  # ============================================================================
  aggregate-reviews:
    needs: [check-trigger, review-claude, review-gemini, review-openai, review-kimi]
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        id: setup
        run: |
          BOT_USER_ID=$(gh api "/users/${{ needs.check-trigger.outputs.app-slug }}[bot]" --jq .id || echo "")
          echo "user-id=$BOT_USER_ID" >> "$GITHUB_OUTPUT"
          mkdir -p $HOME/.claude-code-router/plugins

          # Gemini Schema Fix - handles thought_signature and cleans unsupported schema props
          cat > $HOME/.claude-code-router/plugins/gemini-schema-fix.js << 'SCHEMAFIX'
          const UNSUPPORTED = ['propertyNames', 'patternProperties', 'additionalItems', 'unevaluatedProperties', 'unevaluatedItems', 'contentEncoding', 'contentMediaType', 'contentSchema', '$schema', '$id', '$ref', '$defs', 'definitions', 'if', 'then', 'else', 'allOf', 'anyOf', 'oneOf', 'not', 'dependentSchemas', 'dependentRequired', 'minContains', 'maxContains'];

          function cleanSchema(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            if (Array.isArray(obj)) return obj.map(cleanSchema);
            const cleaned = {};
            for (const [key, value] of Object.entries(obj)) {
              if (!UNSUPPORTED.includes(key)) {
                cleaned[key] = cleanSchema(value);
              }
            }
            return cleaned;
          }

          class GeminiSchemaFixTransformer {
            constructor(options) {
              this.name = 'gemini-schema-fix';
              this.SKIP_SIGNATURE = 'skip_thought_signature_validator';
            }
            async transformRequestIn(body, provider, context) {
              const model = (body.model || '').toLowerCase();
              const isGemini = model.includes('gemini');

              // Add thought_signature bypass for Gemini
              if (isGemini && body.messages) {
                body.messages = body.messages.map(msg => {
                  if (msg.role === 'assistant' && msg.tool_calls && Array.isArray(msg.tool_calls)) {
                    return {
                      ...msg,
                      tool_calls: msg.tool_calls.map(tc => {
                        if (tc.function && !tc.function.thought_signature) {
                          return { ...tc, function: { ...tc.function, thought_signature: this.SKIP_SIGNATURE } };
                        }
                        return tc;
                      })
                    };
                  }
                  return msg;
                });
              }

              // Clean tool schemas for all models (removes unsupported JSON schema props)
              if (body.tools && Array.isArray(body.tools)) {
                body.tools = body.tools.map(tool => {
                  if (tool.function && tool.function.parameters) {
                    tool.function.parameters = cleanSchema(tool.function.parameters);
                  }
                  return tool;
                });
              }
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = GeminiSchemaFixTransformer;
          SCHEMAFIX

          # Aggregator params transformer
          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              body.reasoning_effort = 'high';
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/gemini-schema-fix.js", "options": {}},
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["gemini-large", "perplexity-reasoning"],
              "transformer": {"use": ["gemini-schema-fix", "superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,gemini-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}
          token: ${{ steps.token.outputs.token }}

      - name: Download All Reviews
        uses: actions/download-artifact@v4
        with:
          pattern: review-*
          merge-multiple: true
          path: reviews/

      - name: Aggregate Reviews
        id: aggregate
        run: |
          echo "# Individual Model Reviews" > all_reviews.md
          echo "" >> all_reviews.md
          echo "Reviewers: Claude Opus 4.5 (Security) | GPT 5.2 (Bugs) | Gemini 3 Pro (Architecture) | Kimi K2 (Performance)" >> all_reviews.md
          echo "" >> all_reviews.md

          for f in reviews/*.md; do
            if [ -f "$f" ]; then
              cat "$f" >> all_reviews.md
              echo "" >> all_reviews.md
              echo "---" >> all_reviews.md
              echo "" >> all_reviews.md
            fi
          done

          cat all_reviews.md

          {
            echo 'REVIEWS<<EOF'
            cat all_reviews.md
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Final Aggregated Review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
          GIT_AUTHOR_NAME: "${{ needs.check-trigger.outputs.app-slug }}[bot]"
          GIT_AUTHOR_EMAIL: "${{ steps.setup.outputs.user-id }}+${{ needs.check-trigger.outputs.app-slug }}[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "${{ needs.check-trigger.outputs.app-slug }}[bot]"
          GIT_COMMITTER_EMAIL: "${{ steps.setup.outputs.user-id }}+${{ needs.check-trigger.outputs.app-slug }}[bot]@users.noreply.github.com"
        with:
          anthropic_api_key: "ccr-pollinations"
          github_token: ${{ steps.token.outputs.token }}
          trigger_phrase: "superpolly"
          claude_args: |
            --system-prompt "You are SuperPolly, aggregating 4 model reviews: Claude (Security), GPT 5.2 (Bugs), Gemini 3 Pro (Architecture), Kimi K2 (Performance). Synthesize into ONE final review. Be EXTREMELY concise. Format however suits the review best. Prioritize actionable feedback. If models agree on something, highlight it."
          prompt: |
            ${{ env.REVIEWS }}
          additional_permissions: |
            actions: read
