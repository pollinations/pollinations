# Pollinations AI - Multi-Model Review Assistant (SuperPolly)
# Trigger: superpolly | Whitelist: voodoohop, ElliotEtag, eulervoid, Circuit-Overtime, Itachi-1824
#
# Architecture: 4 specialized models review in parallel, then 1 aggregator synthesizes
# - Claude Opus 4.5 (claude-large): Security specialist - best-in-class security robustness (4.7% injection success rate)
# - GPT 5.2 (openai-large): Bug hunter - best async code review, catches cross-system bugs
# - Gemini 3 Pro (gemini-large): Architecture reviewer - native multimodal, design patterns
# - Kimi K2 Thinking (kimi-k2-thinking): Performance & reasoning - transparent chain-of-thought, systematic debugging

name: SuperPolly

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  check-trigger:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'superpolly')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, 'superpolly')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, 'superpolly')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, 'superpolly') || contains(github.event.issue.title, 'superpolly')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    outputs:
      authorized: ${{ steps.whitelist.outputs.authorized }}
      app-slug: ${{ steps.token.outputs.app-slug }}
      user-id: ${{ steps.setup.outputs.user-id }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - name: Check Whitelist
        id: whitelist
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.token.outputs.token }}
          script: |
            let body = '';
            if (context.eventName === 'issue_comment' || context.eventName === 'pull_request_review_comment') {
              body = context.payload.comment?.body || '';
            } else if (context.eventName === 'issues') {
              body = (context.payload.issue?.body || '') + (context.payload.issue?.title || '');
            } else if (context.eventName === 'pull_request_review') {
              body = context.payload.review?.body || '';
            }

            if (!body.includes('superpolly')) {
              console.log('Strict check failed: "superpolly" must be lowercase.');
              core.setOutput('authorized', 'false');
              return;
            }

            const whitelist = ['voodoohop', 'ElliotEtag', 'eulervoid', 'Circuit-Overtime', 'Itachi-1824'];
            const actor = context.actor;
            if (!whitelist.includes(actor)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue?.number || context.payload.pull_request?.number,
                body: `Sorry @${actor}, only whitelisted users can use SuperPolly.`
              });
              core.setOutput('authorized', 'false');
            } else {
              core.setOutput('authorized', 'true');
            }

      - name: Add Reaction
        if: steps.whitelist.outputs.authorized == 'true'
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions -f content=rocket || true
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            gh api repos/${{ github.repository }}/pulls/comments/${{ github.event.comment.id }}/reactions -f content=rocket || true
          elif [ "${{ github.event_name }}" = "issues" ]; then
            gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions -f content=rocket || true
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/reactions -f content=rocket || true
          fi
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}

      - name: Get Bot User ID
        if: steps.whitelist.outputs.authorized == 'true'
        id: setup
        run: |
          BOT_USER_ID=$(gh api "/users/${{ steps.token.outputs.app-slug }}[bot]" --jq .id)
          echo "user-id=$BOT_USER_ID" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}

  # ============================================================================
  # PARALLEL REVIEW JOBS - All 4 run concurrently with specialized roles
  # ============================================================================

  # Claude Opus 4.5 - SECURITY SPECIALIST
  # Why: Best-in-class security (4.7% prompt injection success rate), excellent at detecting manipulation
  review-claude:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      review: ${{ steps.claude-review.outputs.review }}
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          # Claude: seed, temp only
          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              console.log('[superpolly] Claude: seed=-1, temp=0.3');
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["claude-large", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,claude-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}
          token: ${{ steps.token.outputs.token }}

      - name: Run Claude Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: "ccr-pollinations"
          github_token: ${{ steps.token.outputs.token }}
          trigger_phrase: "superpolly"
          prompt: |
            You are Claude Opus 4.5, the SECURITY SPECIALIST in a multi-model code review team.

            You have web search capability - use it to look up latest security best practices, CVEs, or OWASP guidelines when relevant.

            Your primary focus: Security vulnerabilities, but you're not limited to just security - report any issues you find.

            Security priorities:
            - Input validation (SQL injection, XSS, command injection)
            - Authentication/authorization flaws
            - Data exposure and secrets handling
            - Unsafe cryptographic practices
            - Race conditions and thread safety
            - Prompt injection risks in AI-facing code

            Be concise. Include line numbers. Start with "## Claude (Security)"

  # GPT 5.2 - BUG HUNTER
  # Why: Best-in-class async code review, 98.7% tool-calling accuracy, catches cross-system bugs
  review-openai:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      review: ${{ steps.openai-review.outputs.review }}
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          # OpenAI: supports reasoning_effort=xhigh
          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              console.log('[superpolly] OpenAI: seed=-1, temp=0.3, reasoning_effort=xhigh');
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              body.reasoning_effort = 'xhigh';
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["openai-large", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,openai-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}
          token: ${{ steps.token.outputs.token }}

      - name: Run OpenAI Review
        id: openai-review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: "ccr-pollinations"
          github_token: ${{ steps.token.outputs.token }}
          trigger_phrase: "superpolly"
          prompt: |
            You are GPT 5.2, the BUG HUNTER in a multi-model code review team.

            You have web search capability - use it to look up known bugs, library issues, or best practices when relevant.

            Your primary focus: Finding bugs and logic errors, but you're not limited to just bugs - report any issues you find.

            Bug hunting priorities:
            - Logic errors and incorrect behavior
            - Edge cases and boundary conditions
            - Null/undefined handling gaps
            - Error handling completeness
            - Off-by-one errors
            - Cross-file dependency issues
            - Race conditions in async code

            Be concise. Include line numbers. Start with "## GPT 5.2 (Bugs)"

  # Gemini 3 Pro - ARCHITECTURE REVIEWER
  # Why: Native multimodal, excellent at design patterns, relates diagrams to code
  review-gemini:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      review: ${{ steps.gemini-review.outputs.review }}
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          # Gemini: supports reasoning_effort=high only
          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              console.log('[superpolly] Gemini: seed=-1, temp=0.3, reasoning_effort=high');
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              body.reasoning_effort = 'high';
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["gemini-large", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,gemini-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}
          token: ${{ steps.token.outputs.token }}

      - name: Run Gemini Review
        id: gemini-review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: "ccr-pollinations"
          github_token: ${{ steps.token.outputs.token }}
          trigger_phrase: "superpolly"
          prompt: |
            You are Gemini 3 Pro, the ARCHITECTURE REVIEWER in a multi-model code review team.

            You have web search capability - use it to look up design patterns, architectural best practices, or library documentation when relevant.

            Your primary focus: Code structure and design, but you're not limited to just architecture - report any issues you find.

            Architecture priorities:
            - Code organization and modularity
            - Design pattern usage (correct/incorrect)
            - Dependency management and coupling
            - API design and interface consistency
            - Maintainability and technical debt
            - Separation of concerns
            - DRY violations and code duplication

            Be concise. Include line numbers. Start with "## Gemini 3 Pro (Architecture)"

  # Kimi K2 Thinking - PERFORMANCE & REASONING ANALYST
  # Why: Transparent chain-of-thought, systematic debugging, excellent audit trails
  review-kimi:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      review: ${{ steps.kimi-review.outputs.review }}
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        run: |
          mkdir -p $HOME/.claude-code-router/plugins

          # Kimi: has native thinking, no reasoning_effort needed
          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              console.log('[superpolly] Kimi: seed=-1, temp=0.3 (native thinking)');
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["kimi-k2-thinking", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,kimi-k2-thinking",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}
          token: ${{ steps.token.outputs.token }}

      - name: Run Kimi Review
        id: kimi-review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: "ccr-pollinations"
          github_token: ${{ steps.token.outputs.token }}
          trigger_phrase: "superpolly"
          prompt: |
            You are Kimi K2 Thinking, the PERFORMANCE & REASONING ANALYST in a multi-model code review team.

            You have web search capability - use it to look up performance benchmarks, optimization techniques, or algorithm complexity references when relevant.

            Your primary focus: Performance issues and deep reasoning analysis, but you're not limited to just performance - report any issues you find.

            Performance priorities:
            - Algorithmic complexity (O(n) analysis)
            - Memory allocation patterns and leaks
            - Database query efficiency (N+1, missing indexes)
            - Unnecessary computations or redundant operations
            - Caching opportunities
            - Resource cleanup and disposal
            - Async/await inefficiencies

            Use your thinking capability to reason step-by-step about complex issues.
            Be concise in your final output. Include line numbers. Start with "## Kimi K2 (Performance)"

  # ============================================================================
  # AGGREGATION JOB - Synthesizes all 4 reviews into final verdict
  # ============================================================================
  aggregate-reviews:
    needs: [check-trigger, review-claude, review-gemini, review-openai, review-kimi]
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    env:
      CLAUDE_CODE_TOKEN: ${{ secrets.CLAUDE_CODE_TOKEN }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: token
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Router
        id: setup
        run: |
          BOT_USER_ID=$(gh api "/users/${{ needs.check-trigger.outputs.app-slug }}[bot]" --jq .id || echo "")
          echo "user-id=$BOT_USER_ID" >> "$GITHUB_OUTPUT"
          mkdir -p $HOME/.claude-code-router/plugins

          # Aggregator uses Gemini: reasoning_effort=high only
          cat > $HOME/.claude-code-router/plugins/superpolly-transformer.js << 'TRANSFORMER'
          class SuperPollyTransformer {
            constructor(options) { this.name = 'superpolly-transformer'; }
            async transformRequestIn(body, provider, context) {
              console.log('[superpolly] Aggregator (Gemini): seed=-1, temp=0.3, reasoning_effort=high');
              body.stream = true;
              body.seed = -1;
              body.temperature = 0.3;
              body.reasoning_effort = 'high';
              return body;
            }
            async transformResponseOut(response, context) { return response; }
          }
          module.exports = SuperPollyTransformer;
          TRANSFORMER

          cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "LOG": false,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 600000,
            "transformers": [
              {"path": "~/.claude-code-router/plugins/superpolly-transformer.js", "options": {}}
            ],
            "Providers": [{
              "name": "pollinations",
              "api_base_url": "https://gen.pollinations.ai/v1/chat/completions",
              "api_key": "${CLAUDE_CODE_TOKEN}",
              "models": ["gemini-large", "perplexity-reasoning"],
              "transformer": {"use": ["superpolly-transformer"]}
            }],
            "Router": {
              "default": "pollinations,gemini-large",
              "webSearch": "pollinations,perplexity-reasoning"
            }
          }
          EOF
          bunx @musistudio/claude-code-router start &
          until curl -s http://localhost:3456 >/dev/null; do sleep 0.5; done
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || github.sha }}
          token: ${{ steps.token.outputs.token }}

      - name: Download All Reviews
        uses: actions/download-artifact@v4
        with:
          pattern: claude-code-*
          merge-multiple: true
          path: reviews/

      - name: Aggregate Reviews
        id: aggregate
        run: |
          echo "# Individual Model Reviews" > all_reviews.md
          echo "" >> all_reviews.md
          echo "Reviewers: Claude Opus 4.5 (Security) | GPT 5.2 (Bugs) | Gemini 3 Pro (Architecture) | Kimi K2 (Performance)" >> all_reviews.md
          echo "" >> all_reviews.md

          for f in reviews/*.md; do
            if [ -f "$f" ]; then
              cat "$f" >> all_reviews.md
              echo "" >> all_reviews.md
              echo "---" >> all_reviews.md
              echo "" >> all_reviews.md
            fi
          done

          cat all_reviews.md

          {
            echo 'REVIEWS<<EOF'
            cat all_reviews.md
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Final Aggregated Review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
          GIT_AUTHOR_NAME: "${{ needs.check-trigger.outputs.app-slug }}[bot]"
          GIT_AUTHOR_EMAIL: "${{ steps.setup.outputs.user-id }}+${{ needs.check-trigger.outputs.app-slug }}[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "${{ needs.check-trigger.outputs.app-slug }}[bot]"
          GIT_COMMITTER_EMAIL: "${{ steps.setup.outputs.user-id }}+${{ needs.check-trigger.outputs.app-slug }}[bot]@users.noreply.github.com"
        with:
          anthropic_api_key: "ccr-pollinations"
          github_token: ${{ steps.token.outputs.token }}
          trigger_phrase: "superpolly"
          prompt: |
            You are SuperPolly. You just orchestrated 4 different AI models to independently review the same PR/issue:
            - Claude Opus 4.5 focused on SECURITY
            - GPT 5.2 focused on BUGS
            - Gemini 3 Pro focused on ARCHITECTURE
            - Kimi K2 Thinking focused on PERFORMANCE

            Each model analyzed the code from its specialty perspective but could also report other issues they found.

            You have web search capability - use it if you need to verify any claims, look up best practices, or cross-reference recommendations from the reviews.

            Your job: Synthesize these 4 reviews into ONE final, definitive review.

            Rules:
            - Be EXTREMELY concise. No fluff, no filler.
            - Format however you think works best for this specific review
            - Prioritize actionable feedback
            - If all models agree on something, it's probably important
            - If only one model caught something, use your judgment on whether to include it

            ${{ env.REVIEWS }}
          additional_permissions: |
            actions: read
