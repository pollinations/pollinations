name: Backfill Highlights from NEWS Files (July 27 - Dec 7, 2025)

on:
  workflow_dispatch:

jobs:
  # 19 parallel jobs for each week's NEWS file
  week-01:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-08-02"
    secrets: inherit

  week-02:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-08-09"
    secrets: inherit

  week-03:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-08-16"
    secrets: inherit

  week-04:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-08-23"
    secrets: inherit

  week-05:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-08-30"
    secrets: inherit

  week-06:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-09-06"
    secrets: inherit

  week-07:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-09-13"
    secrets: inherit

  week-08:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-09-20"
    secrets: inherit

  week-09:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-09-27"
    secrets: inherit

  week-10:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-10-04"
    secrets: inherit

  week-11:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-10-11"
    secrets: inherit

  week-12:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-10-18"
    secrets: inherit

  week-13:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-10-25"
    secrets: inherit

  week-14:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-11-01"
    secrets: inherit

  week-15:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-11-08"
    secrets: inherit

  week-16:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-11-15"
    secrets: inherit

  week-17:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-11-22"
    secrets: inherit

  week-18:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-11-29"
    secrets: inherit

  week-19:
    uses: ./.github/workflows/temp-highlights-week.yml
    with:
      file_date: "2025-12-07"
    secrets: inherit

  # Final job to combine all highlights into single file and create PR
  create-pr:
    needs: [week-01, week-02, week-03, week-04, week-05, week-06, week-07, week-08, week-09, week-10, week-11, week-12, week-13, week-14, week-15, week-16, week-17, week-18, week-19]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate Pollinations AI Token
        id: pollinations-ai
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: highlights-artifacts
          pattern: highlights-*
          merge-multiple: false

      - name: Combine highlights (newest first)
        run: |
          mkdir -p NEWS/transformed

          # Get all highlight files and sort by date descending (newest first)
          COMBINED=""
          for file in $(ls highlights-artifacts/highlights-*/highlights-*.txt 2>/dev/null | sort -r); do
            if [ -f "$file" ]; then
              CONTENT=$(cat "$file")
              if [ -n "$CONTENT" ] && [ "$CONTENT" != "SKIP" ]; then
                echo "Adding highlights from $file"
                COMBINED="${COMBINED}${CONTENT}"$'\n'
              fi
            fi
          done

          if [ -z "$COMBINED" ]; then
            echo "No highlights found across all weeks"
            exit 0
          fi

          echo "$COMBINED" > NEWS/transformed/highlights.md
          echo "Created highlights.md"
          cat NEWS/transformed/highlights.md

      - name: Create PR with highlights.md
        env:
          GITHUB_TOKEN: ${{ steps.pollinations-ai.outputs.token }}
        run: |
          if [ ! -f "NEWS/transformed/highlights.md" ]; then
            echo "No highlights.md created"
            exit 0
          fi

          git config user.name "pollinations-ai[bot]"
          git config user.email "pollinations-ai[bot]@users.noreply.github.com"

          BRANCH_NAME="backfill-highlights-july-dec-2025"
          git checkout -b "$BRANCH_NAME"

          git add NEWS/transformed/highlights.md

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "docs: backfill highlights.md (July 27 - Dec 7, 2025)"

          git push -u origin "$BRANCH_NAME"

          gh pr create \
            --title "Backfill Highlights - July 27 to Dec 7, 2025" \
            --body "## Highlights Backfill

          This PR creates \`NEWS/transformed/highlights.md\` with curated highlights from 19 weeks of NEWS files.

          Highlights are ordered newest first (Dec 7 at top, Aug 2 at bottom).

          ---
          Generated automatically by backfill workflow." \
            --base main
