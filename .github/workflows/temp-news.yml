name: Backfill NEWS Files (July 27 - Dec 7, 2025)

on:
  workflow_dispatch:

jobs:
  # 19 parallel jobs for each week
  week-01:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-07-27"
      week_end: "2025-08-02"
      file_date: "2025-08-02"
    secrets: inherit

  week-02:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-08-03"
      week_end: "2025-08-09"
      file_date: "2025-08-09"
    secrets: inherit

  week-03:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-08-10"
      week_end: "2025-08-16"
      file_date: "2025-08-16"
    secrets: inherit

  week-04:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-08-17"
      week_end: "2025-08-23"
      file_date: "2025-08-23"
    secrets: inherit

  week-05:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-08-24"
      week_end: "2025-08-30"
      file_date: "2025-08-30"
    secrets: inherit

  week-06:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-08-31"
      week_end: "2025-09-06"
      file_date: "2025-09-06"
    secrets: inherit

  week-07:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-09-07"
      week_end: "2025-09-13"
      file_date: "2025-09-13"
    secrets: inherit

  week-08:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-09-14"
      week_end: "2025-09-20"
      file_date: "2025-09-20"
    secrets: inherit

  week-09:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-09-21"
      week_end: "2025-09-27"
      file_date: "2025-09-27"
    secrets: inherit

  week-10:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-09-28"
      week_end: "2025-10-04"
      file_date: "2025-10-04"
    secrets: inherit

  week-11:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-10-05"
      week_end: "2025-10-11"
      file_date: "2025-10-11"
    secrets: inherit

  week-12:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-10-12"
      week_end: "2025-10-18"
      file_date: "2025-10-18"
    secrets: inherit

  week-13:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-10-19"
      week_end: "2025-10-25"
      file_date: "2025-10-25"
    secrets: inherit

  week-14:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-10-26"
      week_end: "2025-11-01"
      file_date: "2025-11-01"
    secrets: inherit

  week-15:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-11-02"
      week_end: "2025-11-08"
      file_date: "2025-11-08"
    secrets: inherit

  week-16:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-11-09"
      week_end: "2025-11-15"
      file_date: "2025-11-15"
    secrets: inherit

  week-17:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-11-16"
      week_end: "2025-11-22"
      file_date: "2025-11-22"
    secrets: inherit

  week-18:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-11-23"
      week_end: "2025-11-29"
      file_date: "2025-11-29"
    secrets: inherit

  week-19:
    uses: ./.github/workflows/temp-news-week.yml
    with:
      week_start: "2025-11-30"
      week_end: "2025-12-07"
      file_date: "2025-12-07"
    secrets: inherit

  # Final job to create single PR with all files
  create-pr:
    needs: [week-01, week-02, week-03, week-04, week-05, week-06, week-07, week-08, week-09, week-10, week-11, week-12, week-13, week-14, week-15, week-16, week-17, week-18, week-19]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate Polly Bot Token
        id: polly-bot
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: news-artifacts
          pattern: news-*
          merge-multiple: false

      - name: Create NEWS files from artifacts
        run: |
          mkdir -p NEWS
          for dir in news-artifacts/news-*/; do
            if [ -d "$dir" ]; then
              cp "$dir"/*.md NEWS/ 2>/dev/null || true
            fi
          done
          ls -la NEWS/
          echo "Total files: $(ls NEWS/*.md 2>/dev/null | wc -l)"

      - name: Create PR with all NEWS files
        env:
          GITHUB_TOKEN: ${{ steps.polly-bot.outputs.token }}
        run: |
          git config user.name "polly-bot[bot]"
          git config user.email "polly-bot[bot]@users.noreply.github.com"

          BRANCH_NAME="backfill-news-july-dec-2025"
          git checkout -b "$BRANCH_NAME"

          git add NEWS/

          FILE_COUNT=$(git diff --cached --name-only | wc -l)

          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "No new files to commit"
            exit 0
          fi

          git commit -m "docs: backfill NEWS files (July 27 - Dec 7, 2025)

          Added $FILE_COUNT weekly NEWS files covering the backfill period."

          git push -u origin "$BRANCH_NAME"

          gh pr create \
            --title "Backfill NEWS Files - July 27 to Dec 7, 2025" \
            --body "## NEWS Backfill

          This PR adds **$FILE_COUNT** weekly NEWS files covering July 27 - Dec 7, 2025.

          ### Files Added
          \`\`\`
          $(ls NEWS/*.md | sort)
          \`\`\`

          ---
          Generated automatically by backfill workflow." \
            --base main
