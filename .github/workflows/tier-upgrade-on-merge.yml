name: Tier Upgrade on Merge

on:
  pull_request_target:
    types: [closed]
    branches: [main]

concurrency:
  group: tier-upgrade-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  upgrade-tier:
    # Run when PR with tier:review label is merged.
    # The merge is the manual approval - no manual labeling required.
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'tier:review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Generate Pollinations AI Token
        id: pollinations-ai
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.POLLY_BOT_APP_ID }}
          private-key: ${{ secrets.POLLY_BOT_PRIVATE_KEY }}

      - name: Update PR labels (tier:review ‚Üí tier:flower)
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.pollinations-ai.outputs.token }}
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // Remove tier:review
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'tier:review'
              });
            } catch (e) { /* label might not exist */ }
            
            // Add tier:flower
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['tier:flower']
            });
            
            console.log(`Updated PR #${prNumber}: tier:review ‚Üí tier:flower`);

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Determine upgrade targets
        id: targets
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.pollinations-ai.outputs.token }}
          script: |
            const prAuthor = context.payload.pull_request.user.login;
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            
            // Check if this is an app submission PR (has linked issue)
            const closePattern = /(?:closes?|fixes?|resolves?)\s+#(\d+)/gi;
            const issueMatches = [...prBody.matchAll(closePattern)];
            
            const targets = [];
            const seenUsers = new Set(); // Deduplicate by username
            
            if (issueMatches.length > 0) {
              // App submission: upgrade the issue author, celebrate on issue
              for (const match of issueMatches) {
                const issueNumber = parseInt(match[1]);
                try {
                  const { data: issue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });
                  const username = issue.user.login;
                  if (!seenUsers.has(username)) {
                    seenUsers.add(username);
                    targets.push({
                      username: username,
                      celebrateOn: 'issue',
                      targetNumber: issueNumber,
                      type: 'app'
                    });
                  } else {
                    console.log(`Skipping duplicate user: ${username}`);
                  }
                } catch (e) {
                  console.log(`Could not fetch issue #${issueNumber}: ${e.message}`);
                }
              }
            } else {
              // Direct PR: upgrade the PR author, celebrate on PR
              targets.push({
                username: prAuthor,
                celebrateOn: 'pr',
                targetNumber: prNumber,
                type: 'pr'
              });
            }
            
            console.log('Upgrade targets:', JSON.stringify(targets, null, 2));
            core.setOutput('targets', JSON.stringify(targets));
            core.setOutput('pr_number', prNumber);

      - name: Upgrade users to Flower tier
        id: upgrade
        if: steps.targets.outputs.targets != '[]'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          POLAR_ACCESS_TOKEN: ${{ secrets.POLAR_ACCESS_TOKEN }}
          TARGETS: ${{ steps.targets.outputs.targets }}
        run: |
          npm install -g wrangler
          cd enter.pollinations.ai
          npm install
          
          RESULTS="[]"
          
          for row in $(echo "$TARGETS" | jq -c '.[]'); do
            USERNAME=$(echo "$row" | jq -r '.username')
            TARGET_NUMBER=$(echo "$row" | jq -r '.targetNumber')
            CELEBRATE_ON=$(echo "$row" | jq -r '.celebrateOn')
            TYPE=$(echo "$row" | jq -r '.type')
            
            echo "üå∏ Upgrading $USERNAME to flower tier..."
            OUTPUT=$(npx tsx scripts/tier-update-user.ts update-tier \
              --githubUsername "$USERNAME" \
              --tier flower \
              --env production 2>&1) || true
            
            echo "$OUTPUT"
            
            # Check if user already at higher tier (skip silently)
            if echo "$OUTPUT" | grep -q "SKIP_UPGRADE=true"; then
              echo "‚úÖ User $USERNAME already at flower tier or higher - skipping"
              RESULTS=$(echo "$RESULTS" | jq --arg user "$USERNAME" --arg num "$TARGET_NUMBER" --arg on "$CELEBRATE_ON" --arg type "$TYPE" \
                '. + [{"user": $user, "targetNumber": $num, "celebrateOn": $on, "type": $type, "success": "skipped"}]')
            elif echo "$OUTPUT" | grep -q "Tier update complete"; then
              RESULTS=$(echo "$RESULTS" | jq --arg user "$USERNAME" --arg num "$TARGET_NUMBER" --arg on "$CELEBRATE_ON" --arg type "$TYPE" \
                '. + [{"user": $user, "targetNumber": $num, "celebrateOn": $on, "type": $type, "success": true}]')
            else
              RESULTS=$(echo "$RESULTS" | jq --arg user "$USERNAME" --arg num "$TARGET_NUMBER" --arg on "$CELEBRATE_ON" --arg type "$TYPE" \
                '. + [{"user": $user, "targetNumber": $num, "celebrateOn": $on, "type": $type, "success": false}]')
            fi
          done
          
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post celebration and update labels
        if: steps.upgrade.outputs.results != '[]' && steps.upgrade.outputs.results != ''
        uses: actions/github-script@v7
        env:
          RESULTS_JSON: ${{ steps.upgrade.outputs.results }}
          PR_NUMBER: ${{ steps.targets.outputs.pr_number }}
        with:
          github-token: ${{ steps.pollinations-ai.outputs.token }}
          script: |
            const results = JSON.parse(process.env.RESULTS_JSON);
            const prNumber = parseInt(process.env.PR_NUMBER);
            
            for (const result of results) {
              const targetNumber = parseInt(result.targetNumber);
              const isIssue = result.celebrateOn === 'issue';
              
              // Skip if user already at higher tier (no action needed)
              if (result.success === 'skipped') {
                console.log(`Skipping ${result.user} - already at flower tier or higher`);
                continue;
              }
              
              if (result.success === true) {
                // Post success message
                const successMessage = result.type === 'app'
                  ? `## üéâ App Approved!\n\nYour app has been added to the [pollinations.ai showcase](https://pollinations.ai)!\n\n### üå∏ Flower Tier Activated!\n\n@${result.user}, you've been upgraded to **Flower tier** which grants you **10 pollen per day**!\n\n‚è∞ **How it works:** Your pollen balance refills every 24 hours. Unused pollen does not roll over.\n\nCheck your balance at [enter.pollinations.ai](https://enter.pollinations.ai)\n\nThank you for contributing to Pollinations! üåª`
                  : `## üéâ Contribution Merged!\n\nThank you for your contribution to Pollinations!\n\n### üå∏ Flower Tier Activated!\n\n@${result.user}, you've been upgraded to **Flower tier** which grants you **10 pollen per day**!\n\n‚è∞ **How it works:** Your pollen balance refills every 24 hours. Unused pollen does not roll over.\n\nCheck your balance at [enter.pollinations.ai](https://enter.pollinations.ai) üåª`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: targetNumber,
                  body: successMessage
                });
                
                // Update labels: remove tier:flower, add tier:done
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: targetNumber,
                    name: 'tier:flower'
                  });
                } catch (e) { /* label might not exist */ }
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: targetNumber,
                  labels: ['tier:done']
                });
                
                // Also update PR labels if celebrating on issue
                if (isIssue) {
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      name: 'tier:flower'
                    });
                  } catch (e) { /* label might not exist */ }
                  
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    labels: ['tier:done']
                  });
                }
                
                console.log(`‚úÖ Upgraded ${result.user} and posted celebration`);
              } else {
                // User not registered
                const failMessage = `### ‚ö†Ô∏è Action Required: Claim Your Flower Tier\n\n@${result.user}, your contribution has been merged but we couldn't find your account to upgrade your tier.\n\n**To claim your üå∏ Flower tier (10 pollen/day):**\n1. Sign up at [enter.pollinations.ai](https://enter.pollinations.ai) using GitHub\n2. Reply to this ${isIssue ? 'issue' : 'PR'} once you've signed up\n\nWe'll upgrade your tier once you're registered. Thanks for contributing! üåª`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: targetNumber,
                  body: failMessage
                });
                
                // Add pending label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: targetNumber,
                  labels: ['tier:info-needed']
                });
                
                console.log(`‚ö†Ô∏è User ${result.user} not registered, posted reminder`);
              }
            }
