name: User Upgrade Spore to Seed

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  # Step 1: Fetch spore users
  fetch-spore-users:
    runs-on: ubuntu-latest
    outputs:
      users: ${{ steps.fetch.outputs.users }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch spore users
        id: fetch
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          POLAR_ACCESS_TOKEN: ${{ secrets.POLAR_ACCESS_TOKEN }}
        run: |
          npm install -g wrangler
          cd enter.pollinations.ai
          npm install
          
          OUTPUT=$(npx tsx scripts/tier-update-user.ts fetch-tier \
            --tier spore \
            --env production 2>&1) || true
          
          echo "$OUTPUT"
          
          # Extract JSON array of usernames from output
          USERS=$(echo "$OUTPUT" | jq -r '.users // []' 2>/dev/null || echo '[]')
          
          echo "users=$USERS" >> $GITHUB_OUTPUT
          echo "Found $(echo "$USERS" | jq 'length') spore users"

  # Step 2: Validate users
  validate-users:
    runs-on: ubuntu-latest
    needs: fetch-spore-users
    if: needs.fetch-spore-users.outputs.users != '[]'
    outputs:
      approved_users: ${{ steps.validate.outputs.approved_users }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install aiohttp

      - name: Validate users
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPORE_USERS: ${{ needs.fetch-spore-users.outputs.users }}
        run: |
          python -c "
          import asyncio
          import json
          import os
          import sys
          sys.path.insert(0, '.github/scripts')
          from user_validate_github_profile import validate_users

          async def main():
              users = json.loads(os.environ.get('SPORE_USERS', '[]'))
              if not users:
                  print('No users to validate')
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('approved_users=[]\n')
                  return

              print(f'Validating {len(users)} users...')
              print('=' * 50)

              results = await validate_users(users)

              approved = [r for r in results if r.approved]
              denied = [r for r in results if not r.approved]

              print(f'APPROVED ({len(approved)}):')
              print('-' * 50)
              for r in approved:
                  print(f'  ‚úì {r.username}: {r.reason}')

              print()
              print(f'DENIED ({len(denied)}):')
              print('-' * 50)
              for r in denied:
                  print(f'  ‚úó {r.username}: {r.reason}')

              print()
              print('=' * 50)
              print(f'TOTAL: {len(approved)} approved, {len(denied)} denied')

              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f'approved_users={json.dumps([r.username for r in approved])}\n')

          asyncio.run(main())
          "

  # Step 3: Upgrade approved users
  upgrade-users:
    runs-on: ubuntu-latest
    needs: validate-users
    if: needs.validate-users.outputs.approved_users != '[]'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Upgrade users to Seed
        id: upgrade
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          POLAR_ACCESS_TOKEN: ${{ secrets.POLAR_ACCESS_TOKEN }}
          APPROVED_USERS: ${{ needs.validate-users.outputs.approved_users }}
        run: |
          npm install -g wrangler
          cd enter.pollinations.ai
          npm install
          
          RESULTS="[]"
          
          for row in $(echo "$APPROVED_USERS" | jq -c '.[]'); do
            USERNAME="$row"
            
            echo "üå± Upgrading $USERNAME to seed tier..."
            OUTPUT=$(npx tsx scripts/tier-update-user.ts update-tier \
              --githubUsername "$USERNAME" \
              --tier seed \
              --env production 2>&1) || true
            
            echo "$OUTPUT"
            
            # Check if user already at higher tier (skip silently)
            if echo "$OUTPUT" | grep -q "SKIP_UPGRADE=true"; then
              echo "‚úÖ User $USERNAME already at seed tier or higher - skipping"
              RESULTS=$(echo "$RESULTS" | jq --arg user "$USERNAME" \
                '. + [{"user": $user, "success": "skipped"}]')
            elif echo "$OUTPUT" | grep -q "Tier update complete"; then
              # Verify the tier was actually set correctly in both D1 and Polar
              echo "üîç Verifying tier upgrade for $USERNAME..."
              VERIFY_OUTPUT=$(npx tsx scripts/tier-update-user.ts verify-tier \
                --githubUsername "$USERNAME" \
                --tier seed \
                --env production 2>&1) || true
              
              echo "$VERIFY_OUTPUT"
              
              if echo "$VERIFY_OUTPUT" | grep -q "VERIFIED=true"; then
                echo "‚úÖ Tier verified for $USERNAME"
                RESULTS=$(echo "$RESULTS" | jq --arg user "$USERNAME" \
                  '. + [{"user": $user, "success": true}]')
              else
                echo "‚ö†Ô∏è Tier verification failed for $USERNAME"
                RESULTS=$(echo "$RESULTS" | jq --arg user "$USERNAME" \
                  '. + [{"user": $user, "success": "unverified"}]')
              fi
            else
              RESULTS=$(echo "$RESULTS" | jq --arg user "$USERNAME" \
                '. + [{"user": $user, "success": false}]')
            fi
          done
          
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Report upgrade results
        if: steps.upgrade.outputs.results != '[]' && steps.upgrade.outputs.results != ''
        run: |
          RESULTS='${{ steps.upgrade.outputs.results }}'
          
          echo "üìä Upgrade Results:"
          echo "=================="
          
          APPROVED=$(echo "$RESULTS" | jq '[.[] | select(.success == true)] | length')
          SKIPPED=$(echo "$RESULTS" | jq '[.[] | select(.success == "skipped")] | length')
          UNVERIFIED=$(echo "$RESULTS" | jq '[.[] | select(.success == "unverified")] | length')
          FAILED=$(echo "$RESULTS" | jq '[.[] | select(.success == false)] | length')
          
          echo "‚úÖ Upgraded: $APPROVED"
          echo "‚è≠Ô∏è  Skipped: $SKIPPED"
          echo "‚ö†Ô∏è  Unverified: $UNVERIFIED"
          echo "‚ùå Failed: $FAILED"
          
          echo ""
          echo "Details:"
          echo "$RESULTS" | jq -r '.[] | "  - \(.user): \(.success)"'
