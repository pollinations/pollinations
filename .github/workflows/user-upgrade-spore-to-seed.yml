name: User Upgrade Spore to Seed

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  # Step 1: Fetch spore users
  fetch-spore-users:
    runs-on: ubuntu-latest
    outputs:
      users: ${{ steps.fetch.outputs.users }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch spore users
        id: fetch
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          POLAR_ACCESS_TOKEN: ${{ secrets.POLAR_ACCESS_TOKEN }}
        run: |
          npm install -g wrangler
          cd enter.pollinations.ai
          npm install
          
          OUTPUT=$(npx tsx scripts/tier-update-user.ts fetch-tier \
            --tier spore \
            --env production 2>&1) || true
          
          echo "$OUTPUT"
          
          # Extract JSON array of usernames from output
          USERS=$(echo "$OUTPUT" | jq -r '.users // []' 2>/dev/null || echo '[]')
          
          echo "users=$USERS" >> $GITHUB_OUTPUT
          echo "Found $(echo "$USERS" | jq 'length') spore users"

  # Step 2: Validate users
  validate-users:
    runs-on: ubuntu-latest
    needs: fetch-spore-users
    if: needs.fetch-spore-users.outputs.users != '[]'
    outputs:
      approved_users: ${{ steps.validate.outputs.approved_users }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate users
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SPORE_USERS: ${{ needs.fetch-spore-users.outputs.users }}
        run: |
          python -c "
          import json, os, sys
          sys.path.insert(0, '.github/scripts')
          from user_validate_github_profile import validate_users

          users = json.loads(os.environ.get('SPORE_USERS', '[]'))
          if not users:
              print('No users to validate')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('approved_users=[]\n')
              exit(0)

          results = validate_users(users)
          approved = [r['username'] for r in results if r['approved']]
          print(f'{len(approved)}/{len(users)} approved')

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'approved_users={json.dumps(approved)}\n')
          "

  # Step 3: Upgrade approved users
  upgrade-users:
    runs-on: ubuntu-latest
    needs: validate-users
    if: needs.validate-users.outputs.approved_users != '[]'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Upgrade users to Seed
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          POLAR_ACCESS_TOKEN: ${{ secrets.POLAR_ACCESS_TOKEN }}
          APPROVED_USERS: ${{ needs.validate-users.outputs.approved_users }}
        run: |
          npm install -g wrangler
          cd enter.pollinations.ai
          npm install
          
          for row in $(echo "$APPROVED_USERS" | jq -r '.[]'); do
            echo "üå± Upgrading $row to seed tier..."
            npx tsx scripts/tier-update-user.ts update-tier \
              --githubUsername "$row" \
              --tier seed \
              --env production && echo "‚úÖ $row upgraded" || echo "‚ùå $row failed"
          done
