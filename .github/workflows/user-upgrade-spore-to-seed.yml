name: User Upgrade Spore to Seed

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (fetch and validate only, no upgrades)'
        type: boolean
        default: false
      resume_from:
        description: 'Resume from checkpoint (artifact name from previous run)'
        type: string
        default: ''

# Prevent concurrent runs - this workflow modifies user tiers
concurrency:
  group: user-upgrade-spore-to-seed
  cancel-in-progress: false  # Don't cancel in-progress runs, wait for them

jobs:
  upgrade-spore-to-seed:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hour limit (should complete in ~2h)

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd enter.pollinations.ai && npm install
          pip install tqdm

      # Download checkpoint from previous run if resuming
      - name: Download checkpoint
        if: inputs.resume_from != ''
        uses: dawidd6/action-download-artifact@v3
        with:
          name: ${{ inputs.resume_from }}
          path: .github/scripts/
        continue-on-error: true

      - name: Run upgrade script
        id: upgrade
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          POLAR_ACCESS_TOKEN: ${{ secrets.POLAR_ACCESS_TOKEN }}
        run: |
          set +e  # Don't exit on error, we want to save checkpoint
          python .github/scripts/user_upgrade_spore_to_seed.py ${{ inputs.dry_run && '--dry-run' || '' }}
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit 0  # Always succeed to allow artifact upload

      # Save checkpoint for resume capability
      - name: Save checkpoint
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkpoint-${{ github.run_number }}
          path: |
            .github/scripts/upgrade_checkpoint.json
          retention-days: 7
          if-no-files-found: ignore

      # Generate workflow summary
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸŒ± Spore â†’ Seed Upgrade Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f .github/scripts/upgrade_results.json ]; then
            echo "### Statistics" >> $GITHUB_STEP_SUMMARY
            cat .github/scripts/upgrade_results.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          print(f\"- **Total spore users:** {data.get('total_spore', 'N/A')}\")
          print(f\"- **Validated:** {data.get('validated', 'N/A')}\")
          print(f\"- **Approved for upgrade:** {data.get('approved', 'N/A')}\")
          print(f\"- **Successfully upgraded:** {data.get('upgraded', 'N/A')}\")
          print(f\"- **Failed upgrades:** {data.get('failed', 'N/A')}\")
          if data.get('rate_limited'):
              print(f\"- âš ï¸ **Rate limited:** Yes (checkpoint saved)\")
          " >> $GITHUB_STEP_SUMMARY
          else
            echo "No results file found. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Run: ${{ github.run_number }} | Mode: ${{ inputs.dry_run && 'Dry Run' || 'Live' }}_" >> $GITHUB_STEP_SUMMARY

      # Fail the job if script actually failed
      - name: Check result
        if: steps.upgrade.outputs.exit_code != '0'
        run: |
          echo "Script failed with exit code ${{ steps.upgrade.outputs.exit_code }}"
          exit ${{ steps.upgrade.outputs.exit_code }}
