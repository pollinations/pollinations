{
  "permissions": {
    "allow": [
      "Bash(dir)",
      "Bash(dir enter.pollinations.ai)",
      "Bash(dir text.pollinations.ai)",
      "Bash(dir image.pollinations.ai)",
      "Bash(dir .github)",
      "Bash(dir .github\\workflows)",
      "Bash(dir pollinations.ai)",
      "Bash(dir pollinations-react)",
      "Bash(dir pollinations.ai\\src)",
      "Bash(dir pollinations-react\\src)",
      "Bash(dir enter.pollinations.ai\\src)",
      "Bash(git checkout:*)",
      "Bash(where git)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" checkout -b feat/pending-spend-reservation-#6083)",
      "Edit(enter.pollinations.ai\\src\\middleware/**)",
      "Bash(cd enter.pollinations.ai && type src\\middleware\\track.ts | findstr /N \"register pollen consumption\" )",
      "Edit(enter.pollinations.ai/**)",
      "Edit(enter.pollinations.ai\\src\\durable-objects/**)",
      "Edit(enter.pollinations.ai\\src\\routes/**)",
      "Bash(cd enter.pollinations.ai && copy wrangler.toml wrangler.toml.backup)",
      "Edit(enter.pollinations.ai\\src/**)",
      "Bash(cd enter.pollinations.ai/src && echo export { PendingSpendReservation } from \"./durable-objects/PendingSpendReservation.ts\"; >> index.ts)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" status)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" add enter.pollinations.ai/src/durable-objects/PendingSpendReservation.ts enter.pollinations.ai/src/middleware/pending-spend.ts enter.pollinations.ai/src/middleware/polar.ts enter.pollinations.ai/src/utils/cost-estimation.ts enter.pollinations.ai/src/routes/proxy.ts enter.pollinations.ai/src/index.ts enter.pollinations.ai/worker-bindings.d.ts enter.pollinations.ai/wrangler.toml)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" commit -m \"$(cat <<'EOF'\nfeat: add pending spend reservation system to prevent parallel request abuse (#6083)\n\n- Add PendingSpendReservation Durable Object for atomic fund reservations\n- Implement pending-spend middleware to reserve estimated costs before processing\n- Update polar middleware to check both DB events + DO reservations\n- Add cost estimation utility with conservative buffer\n- Configure all environments with v3 migrations for new DO\n- Export PendingSpendReservation in index.ts\n\nImplements \"Final Boss\" billing protection: reserves funds atomically BEFORE\nrequest processing, preventing users from firing 100 requests when they only\nhave balance for 1. Closes parallel request abuse race condition.\n\nðŸ¾ Generated with [Letta Code](https://letta.com)\n\nCo-Authored-By: Letta <noreply@letta.com>\nEOF\n)\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" log --oneline -1)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" commit --amend -m \"feat: add pending spend reservation system (#6083)\" -m \"- Add PendingSpendReservation Durable Object for atomic fund reservations\" -m \"- Implement pending-spend middleware to reserve estimated costs\" -m \"- Update polar middleware to check DB + DO reservations\" -m \"- Add cost estimation utility with conservative buffer\" -m \"- Configure all environments with v3 migrations\" -m \"\" -m \"Prevents parallel request abuse by reserving funds BEFORE processing.\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" push origin feat/pending-spend-reservation-#6083)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" add -A)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" reset .letta/)",
      "Bash(echo:*)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" status --short)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" reset enter.pollinations.ai/wrangler.toml.backup)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" commit -m \"fix: patch critical billing vulnerabilities in reservation system\" -m \"- Fix middleware leak: wrap next() in try/finally to release on errors\" -m \"- Fix infinite credit loophole: validate balance atomically in DO\" -m \"- Pass availableBalance to reserveSpend for atomic validation\" -m \"- Fetch user balance directly in middleware (avoid circular deps)\" -m \"- Add .letta/ to gitignore\" -m \"\" -m \"Prevents: money jail (trapped funds) + parallel abuse (unlimited requests)\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" fetch origin)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" checkout JSON-setup)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" add enter.pollinations.ai/src/middleware/json-schema-validation.ts)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" commit -m \"fix: prevent data corruption in SSE streaming by buffering incomplete lines\" -m \"- Add lineBuffer to hold incomplete lines across TCP packet boundaries\" -m \"- Only process complete lines (ending with \\\\n)\" -m \"- Keep last split element in buffer for next iteration\" -m \"- Process remaining buffer contents when stream ends\" -m \"\" -m \"Prevents JSON.parse() errors when TCP packets split in the middle\" -m \"of SSE data lines (e.g., {\\\"conte splitting across packets).\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" push origin JSON-setup)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" commit -m \"fix: prevent emoji/Unicode corruption by reusing TextDecoder with streaming\" -m \"- Move TextDecoder outside loop (was creating new instance per chunk)\" -m \"- Use decoder.decode(value, { stream: true }) for multi-byte chars\" -m \"- Document validation timing trade-off (speed vs prevention)\" -m \"\" -m \"Prevents ï¿½ replacement characters when emojis or Unicode text\" -m \"are split across TCP packet boundaries (e.g., ðŸŒŸ split as bytes).\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" checkout CSP)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" add enter.pollinations.ai/src/middleware/csp.ts)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" commit -m \"fix: close CSP security vulnerabilities with nonce-based script protection\" -m \"SECURITY FIXES:\" -m \"1. Removed 'unsafe-inline' from production script-src (was defeating CSP)\" -m \"2. Injected nonce into CSP header: script-src 'self' 'nonce-\\${nonce}'\" -m \"3. Store nonce in context (c.set) for template access\" -m \"\" -m \"Before: script-src 'self' 'unsafe-inline' (allowed ANY script to run)\" -m \"After:  script-src 'self' 'nonce-abc123' (only nonce-tagged scripts)\" -m \"\" -m \"Development still uses unsafe-inline for debugging convenience.\" -m \"Styles keep unsafe-inline (Scalar library requirement).\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" push origin CSP)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" add shared/registry/pollen-precision.ts enter.pollinations.ai/MIGRATION-INTEGER-BALANCE.md)",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" commit -m \"fix: add integer balance foundation to prevent floating point errors (#6134)\" -m \"THE PROBLEM:\" -m \"- Storing money as REAL (float) causes precision errors\" -m \"- 0.1 + 0.2 = 0.30000000000000004\" -m \"- Users get stuck with \\$0.00000001 they can't spend\" -m \"- Accounting doesn't add up exactly over time\" -m \"\" -m \"THE SOLUTION:\" -m \"- Store as INTEGER in micro-pollen (1 pollen = 1,000,000 micro-pollen)\" -m \"- Provides 6 decimal places (enough for smallest price)\" -m \"- All arithmetic is exact (no floating point errors)\" -m \"\" -m \"ADDED:\" -m \"- pollen-precision.ts: Conversion utilities (toMicroPollen, fromMicroPollen)\" -m \"- MIGRATION-INTEGER-BALANCE.md: Comprehensive implementation plan\" -m \"\" -m \"NEXT STEPS (see migration doc):\" -m \"- Update schema: real() -> integer() for all monetary fields\" -m \"- Convert calculations to use integers\" -m \"- Create database migration to convert existing data\" -m \"- Test with actual pricing examples\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" push origin fix/integer-balance-#6134)",
      "Edit(enter.pollinations.ai\\src\\db\\schema/**)",
      "Bash(cd enter.pollinations.ai/src/db/schema && cp event.ts event.ts.backup)",
      "Bash(copy enter.pollinations.ai\\src\\db\\schema\\event.ts enter.pollinations.ai\\src\\db\\schema\\event.ts.backup)",
      "Bash(cd enter.pollinations.ai/src/db/schema && type event.ts | find /c \"real(\")",
      "Edit(shared\\registry/**)",
      "Bash(cd shared/registry && node -e \"const fs = require('fs'); const content = fs.readFileSync('registry.ts', 'utf-8'); const lines = content.split('\\n'); lines[270] = '        )'; lines.splice(271, 0, '    ); // Convert to micro-pollen (integer)'); fs.writeFileSync('registry.ts', lines.join('\\n'));\")",
      "Bash(\"C:\\Program Files\\Git\\bin\\git.exe\" add enter.pollinations.ai/src/db/schema/event.ts shared/registry/registry.ts COMPLETE-INTEGER-MIGRATION.md)",
      "Bash(powershell -Command \"$content = Get-Content 'shared/registry/registry.ts' -Raw; $content = $content -replace '(\\s+PRECISION,\\r?\\n\\s+)\\);(\\r?\\n\\s+return \\{)', '`$1    )`n    );`$2'; Set-Content 'shared/registry/registry.ts' -Value $content -NoNewline\")",
      "Bash(type:*)",
      "Bash(del COMPLETE-INTEGER-MIGRATION.md && del enter.pollinations.ai\\MIGRATION-INTEGER-BALANCE.md)",
      "Bash(cd shared\\registry && findstr /N \"PRECISION,\" registry.ts | findstr \"271\")"
    ]
  }
}