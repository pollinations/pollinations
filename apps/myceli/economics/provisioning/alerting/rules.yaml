apiVersion: 1

groups:
  - orgId: 1
    name: Server Errors
    folder: Alerts
    interval: 5m
    rules:
      # ðŸ”´ Critical: 75%+ error rate
      - uid: critical-5xx-error-rate
        title: "5xx Error Rate Critical"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PAD1A0A25CD30D456
            model:
              rawSql: |
                WITH error_counts AS (
                  SELECT
                    resolved_model_requested AS model,
                    count() AS server_errors
                  FROM generation_event
                  WHERE
                    start_time >= now() - INTERVAL 10 MINUTE
                    AND response_status >= 500
                    AND response_status < 600
                    AND resolved_model_requested != ''
                    AND resolved_model_requested IS NOT NULL
                  GROUP BY model
                ),
                total_counts AS (
                  SELECT
                    resolved_model_requested AS model,
                    count() AS total_requests
                  FROM generation_event
                  WHERE
                    start_time >= now() - INTERVAL 10 MINUTE
                    AND resolved_model_requested != ''
                    AND resolved_model_requested IS NOT NULL
                  GROUP BY model
                )
                SELECT
                  COALESCE(e.model, t.model) AS model,
                  (COALESCE(e.server_errors, 0) * 100.0 / COALESCE(t.total_requests, 1)) AS value
                FROM error_counts e
                FULL OUTER JOIN total_counts t ON e.model = t.model
                WHERE COALESCE(t.total_requests, 0) > 10
                  AND COALESCE(e.model, t.model) != ''
                  AND COALESCE(e.model, t.model) IS NOT NULL
                ORDER BY model
              format: 1
              queryType: sql
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              settings:
                mode: replaceNN
                replaceWithValue: 0
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 75
                  operator:
                    type: and
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "â€¢ {{ $labels.model }}: 5xx error rate at {{ printf \"%.1f\" $values.B.Value }}% ðŸ”´"
        labels:
          alert_type: server_error
          severity: critical

      # ðŸŸ  Warning: 50-74% error rate
      - uid: warning-5xx-error-rate
        title: "5xx Error Rate Warning"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PAD1A0A25CD30D456
            model:
              rawSql: |
                WITH error_counts AS (
                  SELECT
                    resolved_model_requested AS model,
                    count() AS server_errors
                  FROM generation_event
                  WHERE
                    start_time >= now() - INTERVAL 10 MINUTE
                    AND response_status >= 500
                    AND response_status < 600
                    AND resolved_model_requested != ''
                    AND resolved_model_requested IS NOT NULL
                  GROUP BY model
                ),
                total_counts AS (
                  SELECT
                    resolved_model_requested AS model,
                    count() AS total_requests
                  FROM generation_event
                  WHERE
                    start_time >= now() - INTERVAL 10 MINUTE
                    AND resolved_model_requested != ''
                    AND resolved_model_requested IS NOT NULL
                  GROUP BY model
                )
                SELECT
                  COALESCE(e.model, t.model) AS model,
                  (COALESCE(e.server_errors, 0) * 100.0 / COALESCE(t.total_requests, 1)) AS value
                FROM error_counts e
                FULL OUTER JOIN total_counts t ON e.model = t.model
                WHERE COALESCE(t.total_requests, 0) > 10
                  AND COALESCE(e.model, t.model) != ''
                  AND COALESCE(e.model, t.model) IS NOT NULL
                  AND (COALESCE(e.server_errors, 0) * 100.0 / COALESCE(t.total_requests, 1)) >= 50
                  AND (COALESCE(e.server_errors, 0) * 100.0 / COALESCE(t.total_requests, 1)) < 75
                ORDER BY model
              format: 1
              queryType: sql
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              settings:
                mode: replaceNN
                replaceWithValue: 0
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
                  operator:
                    type: and
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          summary: "â€¢ {{ $labels.model }}: 5xx error rate at {{ printf \"%.1f\" $values.B.Value }}% ðŸŸ "
        labels:
          alert_type: server_error
          severity: warning
