DESCRIPTION >
    Weekly usage statistics - tokens, requests, revenue breakdown by week.
    Includes per-user averages for depth metrics.

TOKEN model_usage READ

NODE weekly_usage_stats_node
SQL >
    %
    WITH weekly_users AS (
        SELECT
            toStartOfWeek(start_time, 1) AS week_start,
            uniqExact(user_id) AS active_users
        FROM generation_event
        WHERE start_time >= now() - INTERVAL {{Int32(weeks_back, 12)}} WEEK
        AND environment = 'production'
        AND user_id != 'undefined'
        AND user_id != ''
        GROUP BY week_start
    )
    SELECT
        formatDateTime(toStartOfWeek(g.start_time, 1), '%Y-%m-%d') AS week,
        count() AS total_requests,
        countIf(event_type = 'text') AS text_requests,
        countIf(event_type = 'image') AS image_requests,
        sum(token_count_prompt_text) AS prompt_tokens,
        sum(token_count_completion_text) AS completion_tokens,
        sum(token_count_prompt_text + token_count_completion_text) AS total_tokens,
        sum(total_price) AS revenue_usd,
        sum(total_cost) AS cost_usd,
        w.active_users,
        if(w.active_users > 0, total_tokens / w.active_users, 0) AS tokens_per_user,
        if(w.active_users > 0, total_requests / w.active_users, 0) AS requests_per_user
    FROM generation_event g
    LEFT JOIN weekly_users w ON toStartOfWeek(g.start_time, 1) = w.week_start
    WHERE g.start_time >= now() - INTERVAL {{Int32(weeks_back, 12)}} WEEK
    AND g.environment = 'production'
    GROUP BY week, w.active_users
    ORDER BY week ASC

TYPE endpoint
