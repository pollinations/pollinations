name = "pollinations-enter"
main = "src/index.ts"
compatibility_date = "2025-11-01"
compatibility_flags = [ "nodejs_compat", "nodejs_als" ]

[dev]
port = 3000

[triggers]
crons = [ "* * * * *" ] # every minute

[assets]
directory = "dist/client"
not_found_handling = "single-page-application"
run_worker_first = [ "/api/*" ]

[[d1_databases]]
binding = "DB"
database_name = "development-pollinations-enter-db"
database_id = "6345cb3c-e57a-4aab-bdd4-bca0de7bd930"
migrations_dir = "drizzle"

[[kv_namespaces]]
# development-pollinations-enter-kv
binding = "KV"
id = "aa0d0aceb6bd45de93032270c7adf4ab"

[[durable_objects.bindings]]
name = "POLLEN_RATE_LIMITER"
class_name = "PollenRateLimiter"
script_name = "pollinations-enter"

[[migrations]]
tag = "v2"
new_classes = ["PollenRateLimiter"]

[vars]
ENVIRONMENT = "development"
LOG_LEVEL = "trace"
ALLOW_ANONYMOUS_USAGE = false
POLAR_SUCCESS_URL = "http://localhost:3000"
POLAR_SERVER = "sandbox"
TINYBIRD_INGEST_URL = "http://localhost:7181/v0/events?name=generation_event"
# Polar product IDs for tier subscriptions (V2 - NEW)
POLAR_PRODUCT_ID_SEED = "82ee54e1-5b69-447b-82aa-3c76bccae193"
POLAR_PRODUCT_ID_FLOWER = "2bfbe9e0-8395-489f-a7a1-6821d835cc08"
POLAR_PRODUCT_ID_NECTAR = "d67b2a25-c4d7-47fa-9d64-4b2a27f0908f"
IMAGE_SERVICE_URL = "http://ec2-3-80-56-235.compute-1.amazonaws.com:16384"
TEXT_SERVICE_URL = "http://ec2-3-80-56-235.compute-1.amazonaws.com:16385"
# Pollen rate limiter configuration
POLLEN_BUCKET_CAPACITY = 0.000000001   # Max pollen in bucket (allows ~2 cheap requests burst)
POLLEN_REFILL_PER_HOUR = 1.0   # Pollen refilled per hour


[env.local]

[[env.local.d1_databases]]
binding = "DB"
database_name = "development-pollinations-enter-db"
database_id = "6345cb3c-e57a-4aab-bdd4-bca0de7bd930"
migrations_dir = "drizzle"

[[env.local.kv_namespaces]]
# development-pollinations-enter-kv
binding = "KV"
id = "aa0d0aceb6bd45de93032270c7adf4ab"

[env.local.vars]
ENVIRONMENT = "local"
LOG_LEVEL = "trace"
ALLOW_ANONYMOUS_USAGE = false
POLAR_SUCCESS_URL = "http://localhost:3000"
POLAR_SERVER = "sandbox"
TINYBIRD_INGEST_URL = "http://localhost:7181/v0/events?name=generation_event"
# Polar product IDs for tier subscriptions
POLAR_PRODUCT_ID_SEED = "19c3291a-e1fa-4a03-a08a-3de9ab84af5d"
POLAR_PRODUCT_ID_FLOWER = "c675a78a-d954-4739-bfad-c0c8aa3e5576"
POLAR_PRODUCT_ID_NECTAR = "dfe978ca-8e07-41fa-992a-ae19ab96e66c"
IMAGE_SERVICE_URL = "http://localhost:16384"
TEXT_SERVICE_URL = "http://localhost:16385"
# Pollen rate limiter configuration


[env.staging]

[[env.staging.routes]]
pattern = "enter.pollinations.ai"
zone_name = "pollinations.ai"
custom_domain = true

[[env.staging.d1_databases]]
binding = "DB"
database_name = "staging-pollinations-enter-db"
database_id = "073195b4-d99e-4b67-9575-eb5efe6d3234"
migrations_dir = "drizzle"

[[env.staging.kv_namespaces]]
# staging-pollinations-enter-kv
binding = "KV"
id = "eb4ea5149a5a413db53902bf2b8c1d95"

[[env.staging.durable_objects.bindings]]
name = "POLLEN_RATE_LIMITER"
class_name = "PollenRateLimiter"
script_name = "pollinations-enter-staging"

[[env.staging.migrations]]
tag = "v2"
deleted_classes = ["RateLimiter"]
new_classes = ["PollenRateLimiter"]

[env.staging.vars]
ENVIRONMENT = "staging"
LOG_LEVEL = "debug"
ALLOW_ANONYMOUS_USAGE = false
POLAR_SUCCESS_URL = "https://enter.pollinations.ai"
POLAR_SERVER = "sandbox"
TINYBIRD_INGEST_URL = "https://api.europe-west2.gcp.tinybird.co/v0/events?name=generation_event"
# Polar product IDs for tier subscriptions (V2 - NEW)
POLAR_PRODUCT_ID_SEED = "82ee54e1-5b69-447b-82aa-3c76bccae193"
POLAR_PRODUCT_ID_FLOWER = "2bfbe9e0-8395-489f-a7a1-6821d835cc08"
POLAR_PRODUCT_ID_NECTAR = "d67b2a25-c4d7-47fa-9d64-4b2a27f0908f"
IMAGE_SERVICE_URL = "http://ec2-3-80-56-235.compute-1.amazonaws.com:16384"
TEXT_SERVICE_URL = "http://ec2-3-80-56-235.compute-1.amazonaws.com:16385"

[env.test]

[[env.test.d1_databases]]
binding = "DB"
database_name = "development-pollinations-enter-db"
database_id = "6345cb3c-e57a-4aab-bdd4-bca0de7bd930"
migrations_dir = "drizzle"

[[env.test.kv_namespaces]]
# development-pollinations-enter-kv
binding = "KV"
id = "aa0d0aceb6bd45de93032270c7adf4ab"

[[env.test.durable_objects.bindings]]
name = "POLLEN_RATE_LIMITER"
class_name = "PollenRateLimiter"

[env.test.vars]
ENVIRONMENT = "test"
LOG_LEVEL = "trace"
ALLOW_ANONYMOUS_USAGE = true
GITHUB_CLIENT_ID = "test_github_client_id"
GITHUB_CLIENT_SECRET = "test_github_client_secret"
POLAR_ACCESS_TOKEN = "test_polar_token"
POLAR_SUCCESS_URL = "http://localhost:3000"
POLAR_SERVER = "sandbox"
TINYBIRD_INGEST_URL = "http://localhost:7181/v0/events?name=generation_event"
POLAR_PRODUCT_ID_SEED = "polar_product_id_seed"
POLAR_PRODUCT_ID_FLOWER = "polar_product_id_flower"
POLAR_PRODUCT_ID_NECTAR = "polar_product_id_nectar"
IMAGE_SERVICE_URL = "http://ec2-3-80-56-235.compute-1.amazonaws.com:16384"
TEXT_SERVICE_URL = "http://ec2-3-80-56-235.compute-1.amazonaws.com:16385"
POLLEN_BUCKET_CAPACITY = 0.002  # Small capacity allowing ~1-2 mock requests before exhaustion
POLLEN_REFILL_PER_HOUR = 0.0036  # 0.000001 pollen per second (slow refill for testing)
