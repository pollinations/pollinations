TOKEN read_pipes READ

DESCRIPTION >
    Get exactly 24 hourly cost values for a specific day (midnight to midnight).
    Returns fixed calendar-aligned buckets with future hours as null/0.

NODE cost_day_node
SQL >
    %
    WITH hour_series AS (
        SELECT 
            toStartOfHour(toDate({{String(date, '2025-08-01')}}) + INTERVAL number HOUR) as hour_start
        FROM numbers(24)
    ),
    user_hourly_costs AS (
        SELECT
            toStartOfHour(timestamp) as hour_start,
            sum(cost) as total_cost
        FROM llm_events
        WHERE 1=1
            {% if defined(user) %}
            AND user = {{String(user, 'default_user')}}
            {% else %}
            AND user = 'default_user'
            {% end %}
            AND timestamp >= toStartOfDay(toDate({{String(date, '2025-08-01')}}))
            AND timestamp < toStartOfDay(toDate({{String(date, '2025-08-01')}}) + INTERVAL 1 DAY)
        GROUP BY hour_start
    )
    SELECT 
        hs.hour_start as hour,
        COALESCE(uhc.total_cost, 0) as total_cost
    FROM hour_series hs
    LEFT JOIN user_hourly_costs uhc ON hs.hour_start = uhc.hour_start
    ORDER BY hour ASC

TYPE endpoint
