TOKEN read_pipes READ

DESCRIPTION >
    Get daily cost values for a specific month (1st to end of month).
    Returns fixed calendar-aligned buckets with future days as null/0.

NODE cost_month_node
SQL >
    %
    WITH month_info AS (
        SELECT 
            toStartOfMonth(toDate({{String(ym, '2025-08')}} || '-01')) as month_start,
            toStartOfMonth(toDate({{String(ym, '2025-08')}} || '-01') + INTERVAL 1 MONTH) as month_end
    ),
    day_series AS (
        SELECT 
            toStartOfDay((SELECT month_start FROM month_info) + INTERVAL number DAY) as day_start
        FROM numbers(
            CAST(dateDiff('day', 
                (SELECT month_start FROM month_info), 
                (SELECT month_end FROM month_info)
            ) AS UInt32)
        )
    ),
    user_daily_costs AS (
        SELECT
            toStartOfDay(timestamp) as day_start,
            sum(cost) as total_cost
        FROM llm_events
        WHERE 1=1
            {% if defined(user) %}
            AND user = {{String(user, 'default_user')}}
            {% else %}
            AND user = 'default_user'
            {% end %}
            AND timestamp >= (SELECT month_start FROM month_info)
            AND timestamp < (SELECT month_end FROM month_info)
        GROUP BY day_start
    )
    SELECT 
        ds.day_start as day,
        COALESCE(udc.total_cost, 0) as total_cost
    FROM day_series ds
    LEFT JOIN user_daily_costs udc ON ds.day_start = udc.day_start
    ORDER BY day ASC

TYPE endpoint
