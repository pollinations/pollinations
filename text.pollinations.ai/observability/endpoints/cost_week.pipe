TOKEN read_pipes READ

DESCRIPTION >
    Get exactly 7 daily cost values for a specific ISO week (Monday to Sunday).
    Returns fixed calendar-aligned buckets with future days as null/0.

NODE cost_week_node
SQL >
    %
    WITH week_start AS (
        SELECT 
            toMonday(toDate(concat(
                substring({{String(isoWeek, '2025-W31')}}, 1, 4), 
                '-01-04'
            )) + INTERVAL (toInt32(substring({{String(isoWeek, '2025-W31')}}, 7)) - 1) * 7 DAY) as week_monday
    ),
    day_series AS (
        SELECT 
            toStartOfDay((SELECT week_monday FROM week_start) + INTERVAL number DAY) as day_start
        FROM numbers(7)
    ),
    user_daily_costs AS (
        SELECT
            toStartOfDay(timestamp) as day_start,
            sum(cost) as total_cost
        FROM llm_events
        WHERE 1=1
            {% if defined(user) %}
            AND user = {{String(user, 'default_user')}}
            {% else %}
            AND user = 'default_user'
            {% end %}
            AND timestamp >= (SELECT week_monday FROM week_start)
            AND timestamp < (SELECT week_monday FROM week_start) + INTERVAL 7 DAY
        GROUP BY day_start
    )
    SELECT 
        ds.day_start as day,
        COALESCE(udc.total_cost, 0) as total_cost
    FROM day_series ds
    LEFT JOIN user_daily_costs udc ON ds.day_start = udc.day_start
    ORDER BY day ASC

TYPE endpoint
