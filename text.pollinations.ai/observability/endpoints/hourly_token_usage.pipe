TOKEN read_pipes READ

DESCRIPTION >
    Get hourly token usage for a specific user

NODE hourly_token_usage_node
SQL >
    %
    SELECT
        toStartOfHour(timestamp) as hour,
        referrer,
        sum(prompt_tokens) as usage_prompt_tokens,
        sum(completion_tokens) as usage_completion_tokens,
        sum(prompt_tokens) + sum(completion_tokens) as total_tokens,
        sum(cost) as total_costs,
        count() as total_requests
    FROM llm_events
    WHERE
        1 = 1
        {% if defined(username) and username != [''] %} AND user IN {{ Array(username) }} {% end %}
        {% if defined(start_date) %} AND timestamp >= {{ DateTime(start_date) }}
        {% else %} AND timestamp >= now() - interval 6 day
        {% end %}
        {% if defined(end_date) %} AND timestamp <= {{ DateTime(end_date) }}
        {% else %} AND timestamp <= now()
        {% end %}
        {% if defined(organization) and organization != [''] %}
            AND organization IN {{ Array(organization) }}
        {% end %}
        {% if defined(project) and project != [''] %} AND project IN {{ Array(project) }} {% end %}
        {% if defined(environment) and environment != [''] %}
            AND environment IN {{ Array(environment) }}
        {% end %}
        {% if defined(model) and model != [''] %} AND model IN {{ Array(model) }} {% end %}
        {% if defined(referrer) and referrer != [''] %} AND referrer IN {{ Array(referrer) }} {% end %}
    GROUP BY hour, referrer
    ORDER BY hour ASC, total_costs DESC

TYPE endpoint